name: Smoke test Python package
description: Tests Python wheel installation and functionality

inputs:
  wheel-path:
    description: Path to the Python wheel file or directory containing wheels
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Smoke test Python wheel
      shell: bash
      run: |
        set -euo pipefail
        tmp=$(mktemp -d)
        cp -R e2e/smoke/python/. "$tmp"/
        pushd "$tmp" >/dev/null

        python -m venv .venv
        if [[ "$RUNNER_OS" == "Windows" ]]; then
          VENV_PY=".venv/Scripts/python.exe"
        else
          VENV_PY=".venv/bin/python"
        fi

        "$VENV_PY" -m pip install --upgrade pip

        if [[ -n "${{ inputs.wheel-path }}" ]]; then
          # Resolve to absolute path if relative
          if [[ "${{ inputs.wheel-path }}" == /* ]]; then
            wheel_path="${{ inputs.wheel-path }}"
          else
            wheel_path="${GITHUB_WORKSPACE}/${{ inputs.wheel-path }}"
          fi

          echo "Looking for wheels in: $wheel_path"

          # If wheel-path is a directory, find the wheel
          if [[ -d "$wheel_path" ]]; then
            wheel_file=$(find "$wheel_path" -name "*.whl" -type f | head -n 1)
            if [[ -z "$wheel_file" ]]; then
              echo "No wheel found in $wheel_path" >&2
              ls -la "$wheel_path" >&2 || true
              exit 1
            fi
            echo "Installing wheel: $wheel_file"
            "$VENV_PY" -m pip install "$wheel_file"
          elif [[ -f "$wheel_path" ]]; then
            echo "Installing wheel: $wheel_path"
            "$VENV_PY" -m pip install "$wheel_path"
          else
            echo "Wheel path does not exist: $wheel_path" >&2
            exit 1
          fi
        else
          # Install from source
          "$VENV_PY" -m pip install "${GITHUB_WORKSPACE}/packages/python"
        fi

        "$VENV_PY" main.py
        popd >/dev/null
        echo "âœ“ Python package smoke test passed"
