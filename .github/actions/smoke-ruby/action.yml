name: Smoke test Ruby gem
description: Tests Ruby gem installation and functionality

inputs:
  gem-path:
    description: Path to the Ruby gem file or directory containing gems
    required: false
    default: ""

runs:
  using: composite
  steps:
    - name: Smoke test Ruby gem
      shell: bash
      run: |
        set -euo pipefail
        tmp=$(mktemp -d)
        cp -R e2e/smoke/ruby/. "$tmp"/
        pushd "$tmp" >/dev/null

        bundle config set --local path vendor/bundle

        if [[ -n "${{ inputs.gem-path }}" ]]; then
          # Resolve to absolute path if relative
          if [[ "${{ inputs.gem-path }}" == /* ]]; then
            gem_path="${{ inputs.gem-path }}"
          else
            gem_path="${GITHUB_WORKSPACE}/${{ inputs.gem-path }}"
          fi

          echo "Looking for gems in: $gem_path"

          # Find gem file
          if [[ -d "$gem_path" ]]; then
            gem_file=$(find "$gem_path" -name "*.gem" -type f | head -n 1)
          else
            gem_file="$gem_path"
          fi

          if [[ -z "$gem_file" || ! -f "$gem_file" ]]; then
            echo "No gem found at $gem_path" >&2
            ls -la "$gem_path" >&2 || true
            exit 1
          fi

          echo "Using gem: $gem_file"

          # Install gem locally
          gem install "$gem_file" --local --no-document
        fi

        bundle install
        bundle exec ruby app.rb
        popd >/dev/null
        echo "âœ“ Ruby gem smoke test passed"
