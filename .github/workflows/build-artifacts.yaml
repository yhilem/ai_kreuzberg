name: Build Artifacts

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (skip actual artifact uploads)"
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'crates/**'
      - 'packages/**'
      - '.github/workflows/build-artifacts.yml'
      - '.github/actions/**'

concurrency:
  group: build-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short
  PDFIUM_VERSION: "7455"
  MACOSX_DEPLOYMENT_TARGET: "14.0"

jobs:
  build-wheels:
    name: Build Python wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
    steps:
      - name: Maximize build disk space
        if: matrix.os == 'ubuntu-latest'
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 512
          swap-size-mb: 4096
          overprovision-lvm: 'true'
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Build wheels
        uses: ./.github/actions/build-wheels
        with:
          python-version: "3.13"

      - name: List built wheels
        shell: bash
        run: |
          echo "ðŸ“¦ Built wheels:"
          ls -lh ./wheelhouse/*.whl || echo "No wheels found"

  build-sdist:
    name: Build Python sdist
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.13"
          cache-prefix: python-sdist

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Build sdist
        working-directory: packages/python
        run: uv run maturin sdist --out ../../dist/

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v5
        with:
          name: python-sdist
          path: dist/*.tar.gz
          retention-days: 7

      - name: List built sdist
        run: |
          echo "ðŸ“¦ Built sdist:"
          ls -lh dist/*.tar.gz

  build-napi-bindings:
    name: Build NAPI ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use_zigbuild: true
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Prepare ONNX Runtime (macOS)
        if: startsWith(matrix.settings.target, 'aarch64-apple-darwin') || startsWith(matrix.settings.target, 'x86_64-apple-darwin')
        uses: ./.github/actions/setup-prebuilt-onnx
        with:
          target: ${{ matrix.settings.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.settings.os }}-cargo-napi-${{ matrix.settings.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cross (Linux cross-compilation)
        if: matrix.settings.use_zigbuild
        run: cargo install cross --git https://github.com/cross-rs/cross --locked

      - name: Build NAPI-RS bindings (with cross)
        if: matrix.settings.use_zigbuild
        working-directory: crates/kreuzberg-node
        run: |
          pnpm install
          pnpm run build --target ${{ matrix.settings.target }} --use-cross

      - name: Build NAPI-RS bindings (native)
        if: ${{ !matrix.settings.use_zigbuild }}
        working-directory: crates/kreuzberg-node
        run: |
          pnpm install
          pnpm run build --target ${{ matrix.settings.target }}

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload NAPI artifacts
        uses: actions/upload-artifact@v5
        with:
          name: napi-${{ matrix.settings.target }}
          path: crates/kreuzberg-node/*.node
          retention-days: 7

      - name: List built bindings
        shell: bash
        run: |
          echo "ðŸ“¦ Built NAPI binding for ${{ matrix.settings.target }}:"
          ls -lh crates/kreuzberg-node/*.node || echo "No .node files found"

  build-ruby-gems:
    name: Build Ruby gem (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    env:
      RB_SYS_CARGO_PROFILE: release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux-x86_64
            platform: x86_64-linux
            build_source_gem: true
          - os: ubuntu-latest
            label: linux-aarch64
            platform: aarch64-linux
            build_source_gem: false
          - os: macos-14
            label: macos-arm64
            platform: arm64-darwin
            build_source_gem: false
          - os: windows-latest
            label: windows-x64
            platform: x64-mingw32
            build_source_gem: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: ruby-${{ matrix.label }}

      - name: Install MSYS2 toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust GNU toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "BINDGEN_EXTRA_CLANG_ARGS=--target=x86_64-pc-windows-gnu --sysroot=${RI_DEVKIT//\\/\/}$MSYSTEM_PREFIX" >> "$GITHUB_ENV"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Stage Pdfium runtime artifacts
        shell: bash
        run: |
          set -euo pipefail
          if [ -z "${KREUZBERG_PDFIUM_PREBUILT:-}" ]; then
            echo "KREUZBERG_PDFIUM_PREBUILT is not set" >&2
            exit 1
          fi
          case "${RUNNER_OS:-unknown}" in
            Windows)
              src="$KREUZBERG_PDFIUM_PREBUILT/bin/pdfium.dll"
              cp -f "$src" "packages/ruby/ext/kreuzberg_rb/native/pdfium.dll"
              cp -f "$src" "packages/ruby/pdfium.dll"
              ;;
            macOS)
              src="$KREUZBERG_PDFIUM_PREBUILT/lib/libpdfium.dylib"
              cp -f "$src" "packages/ruby/ext/kreuzberg_rb/native/libpdfium.dylib"
              cp -f "$src" "packages/ruby/libpdfium.dylib"
              ;;
            Linux)
              src="$KREUZBERG_PDFIUM_PREBUILT/lib/libpdfium.so"
              cp -f "$src" "packages/ruby/ext/kreuzberg_rb/native/libpdfium.so"
              cp -f "$src" "packages/ruby/libpdfium.so"
              ;;
            *)
              echo "Unsupported RUNNER_OS: ${RUNNER_OS:-unknown}" >&2
              exit 1
              ;;
          esac

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $rubydir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle config set --local path 'vendor/bundle' && bundle install --jobs 4 --retry 3"

      - name: Build native gem (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          RUBY_ARCH=$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['arch']")
          bundle exec rake native:kreuzberg:${RUBY_ARCH}

      - name: Package native gem (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          set -euo pipefail
          RUBY_ARCH=$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['arch']")
          STAGE_DIR="tmp/${RUBY_ARCH}/stage"
          mkdir -p pkg
          if [ ! -f "${STAGE_DIR}/kreuzberg.gemspec" ]; then
            echo "Stage directory ${STAGE_DIR} missing" >&2
            exit 1
          fi
          (cd "${STAGE_DIR}" && gem build kreuzberg.gemspec)
          mv "${STAGE_DIR}"/kreuzberg-*.gem pkg/

      - name: Build native gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          # Get Ruby platform in PowerShell first to avoid bash escaping issues
          $rubyPlatform = ruby -e "puts Gem::Platform.local.to_s"
          ridk exec bash -lc "cd $rubydir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle exec rake native:kreuzberg:$rubyPlatform"

      - name: Package native gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          $rubyPlatform = ruby -e "puts Gem::Platform.local.to_s"
          ridk exec bash -lc "cd $rubydir && set -euo pipefail; mkdir -p pkg; stage_dir=\"tmp/$rubyPlatform/stage\"; if [ ! -f \"\$stage_dir/kreuzberg.gemspec\" ]; then echo \"Stage directory \$stage_dir missing\" >&2; exit 1; fi; (cd \"\$stage_dir\" && gem build kreuzberg.gemspec); mv \"\$stage_dir\"/kreuzberg-*.gem pkg/"

      - name: Build source gem
        if: matrix.build_source_gem
        working-directory: packages/ruby
        run: bundle exec rake build

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload native gem artifact
        uses: actions/upload-artifact@v5
        with:
          name: gem-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 7

      - name: List built gems
        shell: bash
        run: |
          echo "ðŸ“¦ Built Ruby gem for ${{ matrix.label }}:"
          ls -lh packages/ruby/pkg/*.gem || echo "No gems found"

  build-cli-binaries:
    name: Build CLI ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: kreuzberg
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: kreuzberg.exe
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: kreuzberg
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-cli-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build CLI binary
        run: cargo build --release --target ${{ matrix.target }} --package kreuzberg-cli

      - name: Create tar.gz for Unix-like systems
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf kreuzberg-${{ matrix.target }}.tar.gz ${{ matrix.artifact_name }}
          mv kreuzberg-${{ matrix.target }}.tar.gz ../../../

      - name: Create zip for Windows
        if: matrix.os == 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          7z a -tzip kreuzberg-${{ matrix.target }}.zip ${{ matrix.artifact_name }}
          mv kreuzberg-${{ matrix.target }}.zip ../../../

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload CLI binary artifacts
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: |
            kreuzberg-${{ matrix.target }}.tar.gz
            kreuzberg-${{ matrix.target }}.zip
          retention-days: 7

      - name: List built binaries
        shell: bash
        run: |
          echo "ðŸ“¦ Built CLI binary for ${{ matrix.target }}:"
          ls -lh kreuzberg-${{ matrix.target }}.* || echo "No archives found"

  summarize:
    name: Build Summary
    needs:
      - build-wheels
      - build-sdist
      - build-napi-bindings
      - build-ruby-gems
      - build-cli-binaries
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Generate build summary
        run: |
          echo "# ðŸ—ï¸ Build Artifacts Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Wheels | ${{ needs.build-wheels.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Sdist | ${{ needs.build-sdist.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NAPI Bindings | ${{ needs.build-napi-bindings.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Gems | ${{ needs.build-ruby-gems.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CLI Binaries | ${{ needs.build-cli-binaries.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Built Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Wheels
          echo "### Python Wheels" >> $GITHUB_STEP_SUMMARY
          wheel_count=$(find artifacts/wheels-* -name "*.whl" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $wheel_count wheels" >> $GITHUB_STEP_SUMMARY
          if [ "$wheel_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/wheels-* -name "*.whl" -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Sdist
          echo "### Python Sdist" >> $GITHUB_STEP_SUMMARY
          sdist_count=$(find artifacts/python-sdist -name "*.tar.gz" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $sdist_count sdist" >> $GITHUB_STEP_SUMMARY
          if [ "$sdist_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/python-sdist -name "*.tar.gz" -exec basename {} \; 2>/dev/null | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # NAPI Bindings
          echo "### NAPI Bindings" >> $GITHUB_STEP_SUMMARY
          napi_count=$(find artifacts/napi-* -name "*.node" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $napi_count bindings" >> $GITHUB_STEP_SUMMARY
          if [ "$napi_count" -gt 0 ]; then
            echo "- **Targets**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/napi-* -type d -name "napi-*" -exec basename {} \; 2>/dev/null | sed 's/napi-/  - /' | sort >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ruby Gems
          echo "### Ruby Gems" >> $GITHUB_STEP_SUMMARY
          gem_count=$(find artifacts/gem-* -name "*.gem" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $gem_count gems" >> $GITHUB_STEP_SUMMARY
          if [ "$gem_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/gem-* -name "*.gem" -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # CLI Binaries
          echo "### CLI Binaries" >> $GITHUB_STEP_SUMMARY
          cli_count=$(find artifacts/cli-* \( -name "*.tar.gz" -o -name "*.zip" \) 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $cli_count binaries" >> $GITHUB_STEP_SUMMARY
          if [ "$cli_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/cli-* \( -name "*.tar.gz" -o -name "*.zip" \) -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.build-wheels.result }}" = "success" ] && \
             [ "${{ needs.build-sdist.result }}" = "success" ] && \
             [ "${{ needs.build-napi-bindings.result }}" = "success" ] && \
             [ "${{ needs.build-ruby-gems.result }}" = "success" ] && \
             [ "${{ needs.build-cli-binaries.result }}" = "success" ]; then
            echo "## âœ… All builds succeeded!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All artifacts are ready for release." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Some builds failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the job details above for more information." >> $GITHUB_STEP_SUMMARY
          fi

          # Dry run notice
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: This was a dry run. No artifacts were published." >> $GITHUB_STEP_SUMMARY
          fi
