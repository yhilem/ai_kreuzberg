name: Build Artifacts

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (skip actual artifact uploads)"
        required: false
        type: boolean
        default: false
  push:
    branches:
      - main
    tags:
      - 'v*'
  pull_request:
    paths:
      - 'crates/**'
      - 'packages/**'
      - '.github/workflows/build-artifacts.yml'
      - '.github/actions/**'

concurrency:
  group: build-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short
  PDFIUM_VERSION: "7455"
  MACOSX_DEPLOYMENT_TARGET: "14.0"

jobs:
  build-wheels:
    name: Build Python wheels (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-x86_64
            os: ubuntu-latest
            artifact: wheels-linux-x86_64
            rust_target: x86_64-unknown-linux-gnu
            manylinux: auto
            python: "3.10"
            needs_qemu: false
            extra_args: ""
          - label: linux-aarch64
            os: ubuntu-latest
            artifact: wheels-linux-aarch64
            rust_target: aarch64-unknown-linux-gnu
            manylinux: auto
            python: "3.10"
            needs_qemu: true
            extra_args: ""
          - label: macos-universal
            os: macos-14
            artifact: wheels-macos
            python: "3.10"
            needs_qemu: false
            rust_target: universal2-apple-darwin
            manylinux: ""
            extra_args: ""
          - label: windows-amd64
            os: windows-latest
            artifact: wheels-windows
            python: "3.10"
            rust_target: x86_64-pc-windows-msvc
            manylinux: ""
            needs_qemu: false
            extra_args: ""
    steps:
      - name: Maximize build disk space
        if: matrix.os == 'ubuntu-latest'
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 512
          swap-size-mb: 4096
          overprovision-lvm: 'true'
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup QEMU
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Cache Pdfium binaries
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Prepare wheel staging directory
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: mkdir -p target/wheels

      - name: Setup Tesseract cache
        id: tesseract-cache
        uses: ./.github/actions/setup-tesseract-cache
        with:
          label: ${{ matrix.label }}
          # enable-cache: ${{ matrix.label != 'linux-aarch64' }}
          rust-target: ${{ matrix.rust_target }}

      - name: Install macOS Rust targets
        if: matrix.label == 'macos-universal'
        shell: bash
        run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

      - name: Build Linux wheels
        if: matrix.os == 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          manylinux: ${{ matrix.manylinux }}
          working-directory: packages/python
          sccache: ${{ steps.tesseract-cache.outputs.cache-enabled }}
          docker-options: ${{ steps.tesseract-cache.outputs.docker-options }}

      - name: Build wheels (native)
        if: matrix.os != 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          working-directory: packages/python
          sccache: ${{ steps.tesseract-cache.outputs.cache-enabled }}

      - name: List built wheels
        shell: bash
        run: ls -lh target/wheels

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.artifact }}
          path: target/wheels/*.whl

  build-sdist:
    name: Build Python sdist
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.13"
          cache-prefix: python-sdist

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Build sdist
        working-directory: packages/python
        run: uv run maturin sdist --out ../../dist/

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v5
        with:
          name: python-sdist
          path: dist/*.tar.gz
          retention-days: 7

      - name: List built sdist
        run: |
          echo "ðŸ“¦ Built sdist:"
          ls -lh dist/*.tar.gz

  build-napi-bindings:
    name: Build NAPI ${{ matrix.settings.target }}
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: ubuntu-latest
            target: x86_64-unknown-linux-musl
            use_zigbuild: true
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Prepare ONNX Runtime (macOS)
        if: startsWith(matrix.settings.target, 'aarch64-apple-darwin') || startsWith(matrix.settings.target, 'x86_64-apple-darwin')
        uses: ./.github/actions/setup-prebuilt-onnx
        with:
          target: ${{ matrix.settings.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.settings.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ matrix.settings.os }}-cargo-napi-${{ matrix.settings.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cross (Linux cross-compilation)
        if: matrix.settings.use_zigbuild
        run: cargo install cross --git https://github.com/cross-rs/cross --locked

      - name: Build NAPI-RS bindings (with cross)
        if: matrix.settings.use_zigbuild
        working-directory: crates/kreuzberg-node
        run: |
          pnpm install
          pnpm run build --target ${{ matrix.settings.target }} --use-cross

      - name: Build NAPI-RS bindings (native)
        if: ${{ !matrix.settings.use_zigbuild }}
        working-directory: crates/kreuzberg-node
        run: |
          pnpm install
          pnpm run build --target ${{ matrix.settings.target }}

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload NAPI artifacts
        uses: actions/upload-artifact@v5
        with:
          name: napi-${{ matrix.settings.target }}
          path: crates/kreuzberg-node/*.node
          retention-days: 7

      - name: List built bindings
        shell: bash
        run: |
          echo "ðŸ“¦ Built NAPI binding for ${{ matrix.settings.target }}:"
          ls -lh crates/kreuzberg-node/*.node || echo "No .node files found"

  build-ruby-gems:
    name: Build Ruby gem (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    env:
      RB_SYS_CARGO_PROFILE: release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux-x86_64
            platform: x86_64-linux
            build_source_gem: true
          - os: ubuntu-latest
            label: linux-aarch64
            platform: aarch64-linux
            build_source_gem: false
          - os: macos-14
            label: macos-arm64
            platform: arm64-darwin
            build_source_gem: false
          - os: windows-latest
            label: windows-x64
            platform: x64-mingw32
            build_source_gem: false
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: ruby-${{ matrix.label }}

      - name: Install MSYS2 toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust GNU toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: echo "BINDGEN_EXTRA_CLANG_ARGS=--target=x86_64-pc-windows-gnu --sysroot=${RI_DEVKIT//\\/\/}$MSYSTEM_PREFIX" >> "$GITHUB_ENV"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Stage Pdfium runtime artifacts
        uses: ./.github/actions/stage-pdfium-runtime
        with:
          destination: packages/ruby/ext/kreuzberg_rb/native
          additional-destinations: packages/ruby

      - name: Setup ONNX Runtime (Windows)
        if: runner.os == 'Windows'
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ONNXRUNTIME_VERSION }}
          dest-dir: packages/ruby/lib

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          bundle config set --local path 'vendor/bundle'
          bundle install --jobs 4 --retry 3

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $rubydir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle config set --local path 'vendor/bundle' && bundle install --jobs 4 --retry 3"

      - name: Build native gem (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          RUBY_ARCH=$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['arch']")
          bundle exec rake native:kreuzberg:${RUBY_ARCH}

      - name: Package native gem (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          set -euo pipefail
          RUBY_ARCH=$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['arch']")
          STAGE_DIR="tmp/${RUBY_ARCH}/stage"
          mkdir -p pkg
          if [ ! -f "${STAGE_DIR}/kreuzberg.gemspec" ]; then
            echo "Stage directory ${STAGE_DIR} missing" >&2
            exit 1
          fi
          (cd "${STAGE_DIR}" && gem build kreuzberg.gemspec)
          mv "${STAGE_DIR}"/kreuzberg-*.gem pkg/

      - name: Build native gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          # Get Ruby platform in PowerShell first to avoid bash escaping issues
          $rubyPlatform = ruby -e "puts Gem::Platform.local.to_s"
          ridk exec bash -lc "cd $rubydir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle exec rake native:kreuzberg:$rubyPlatform"

      - name: Package native gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          $rubyPlatform = ruby -e "puts Gem::Platform.local.to_s"
          ridk exec bash -lc "cd $rubydir && set -euo pipefail; mkdir -p pkg; stage_dir=\"tmp/$rubyPlatform/stage\"; if [ ! -f \"\$stage_dir/kreuzberg.gemspec\" ]; then echo \"Stage directory \$stage_dir missing\" >&2; exit 1; fi; (cd \"\$stage_dir\" && gem build kreuzberg.gemspec); mv \"\$stage_dir\"/kreuzberg-*.gem pkg/"

      - name: Build source gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $rubydir && bundle exec rake build"

      - name: Build source gem
        if: matrix.build_source_gem
        working-directory: packages/ruby
        run: bundle exec rake build

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload native gem artifact
        uses: actions/upload-artifact@v5
        with:
          name: gem-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 7

      - name: List built gems
        shell: bash
        run: |
          echo "ðŸ“¦ Built Ruby gem for ${{ matrix.label }}:"
          ls -lh packages/ruby/pkg/*.gem || echo "No gems found"

  build-cli-binaries:
    name: Build CLI ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: kreuzberg
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: kreuzberg.exe
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: kreuzberg
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-cli-${{ matrix.target }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Build CLI binary
        run: cargo build --release --target ${{ matrix.target }} --package kreuzberg-cli

      - name: Create tar.gz for Unix-like systems
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf kreuzberg-${{ matrix.target }}.tar.gz ${{ matrix.artifact_name }}
          mv kreuzberg-${{ matrix.target }}.tar.gz ../../../

      - name: Create zip for Windows
        if: matrix.os == 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          7z a -tzip kreuzberg-${{ matrix.target }}.zip ${{ matrix.artifact_name }}
          mv kreuzberg-${{ matrix.target }}.zip ../../../

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload CLI binary artifacts
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: |
            kreuzberg-${{ matrix.target }}.tar.gz
            kreuzberg-${{ matrix.target }}.zip
          retention-days: 7

      - name: List built binaries
        shell: bash
        run: |
          echo "ðŸ“¦ Built CLI binary for ${{ matrix.target }}:"
          ls -lh kreuzberg-${{ matrix.target }}.* || echo "No archives found"

  smoke-tests:
    name: Smoke Tests (${{ matrix.flavor }} - ${{ matrix.os }})
    needs:
      - build-wheels
      - build-napi-bindings
      - build-ruby-gems
      - build-cli-binaries
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Python wheels
          - flavor: python
            artifact: wheels-linux-x86_64
            os: ubuntu-latest
            python-version: "3.10"
          - flavor: python
            artifact: wheels-macos
            os: macos-14
            python-version: "3.10"
          - flavor: python
            artifact: wheels-windows
            os: windows-latest
            python-version: "3.10"
          # Node.js packages
          - flavor: node
            artifact: napi-x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - flavor: node
            artifact: napi-aarch64-apple-darwin
            os: macos-14
          - flavor: node
            artifact: napi-x86_64-pc-windows-msvc
            os: windows-latest
          # Ruby gems
          - flavor: ruby
            artifact: gem-linux-x86_64
            os: ubuntu-latest
            ruby-version: "3.3"
          - flavor: ruby
            artifact: gem-macos-arm64
            os: macos-14
            ruby-version: "3.3"
          - flavor: ruby
            artifact: gem-windows-x64
            os: windows-latest
            ruby-version: "3.3"
          # CLI binaries
          - flavor: cli
            artifact: cli-x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - flavor: cli
            artifact: cli-aarch64-apple-darwin
            os: macos-14
          - flavor: cli
            artifact: cli-x86_64-pc-windows-msvc
            os: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup pnpm
        if: matrix.flavor == 'node'
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        if: matrix.flavor == 'node'
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Setup Python
        if: matrix.flavor == 'python'
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup Ruby
        if: matrix.flavor == 'ruby'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}

      - name: Download artifact
        uses: actions/download-artifact@v6
        with:
          name: ${{ matrix.artifact }}
          path: artifacts/${{ matrix.flavor }}

      - name: Smoke test Python wheel
        if: matrix.flavor == 'python'
        uses: ./.github/actions/smoke-python
        with:
          wheel-path: artifacts/${{ matrix.flavor }}

      - name: Smoke test Node.js package
        if: matrix.flavor == 'node'
        uses: ./.github/actions/smoke-node
        with:
          package-tarball: ""

      - name: Smoke test Ruby gem
        if: matrix.flavor == 'ruby'
        uses: ./.github/actions/smoke-ruby
        with:
          gem-path: artifacts/${{ matrix.flavor }}

      - name: Smoke test CLI binary
        if: matrix.flavor == 'cli'
        uses: ./.github/actions/smoke-cli
        with:
          cli-artifacts-dir: artifacts/${{ matrix.flavor }}

  summarize:
    name: Build Summary
    needs:
      - build-wheels
      - build-sdist
      - build-napi-bindings
      - build-ruby-gems
      - build-cli-binaries
      - smoke-tests
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts/

      - name: Generate build summary
        run: |
          echo "# ðŸ—ï¸ Build Artifacts Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Python Wheels | ${{ needs.build-wheels.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Sdist | ${{ needs.build-sdist.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NAPI Bindings | ${{ needs.build-napi-bindings.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Gems | ${{ needs.build-ruby-gems.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CLI Binaries | ${{ needs.build-cli-binaries.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Smoke Tests | ${{ needs.smoke-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Built Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Wheels
          echo "### Python Wheels" >> $GITHUB_STEP_SUMMARY
          wheel_count=$(find artifacts/wheels-* -name "*.whl" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $wheel_count wheels" >> $GITHUB_STEP_SUMMARY
          if [ "$wheel_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/wheels-* -name "*.whl" -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Sdist
          echo "### Python Sdist" >> $GITHUB_STEP_SUMMARY
          sdist_count=$(find artifacts/python-sdist -name "*.tar.gz" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $sdist_count sdist" >> $GITHUB_STEP_SUMMARY
          if [ "$sdist_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/python-sdist -name "*.tar.gz" -exec basename {} \; 2>/dev/null | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # NAPI Bindings
          echo "### NAPI Bindings" >> $GITHUB_STEP_SUMMARY
          napi_count=$(find artifacts/napi-* -name "*.node" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $napi_count bindings" >> $GITHUB_STEP_SUMMARY
          if [ "$napi_count" -gt 0 ]; then
            echo "- **Targets**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/napi-* -type d -name "napi-*" -exec basename {} \; 2>/dev/null | sed 's/napi-/  - /' | sort >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ruby Gems
          echo "### Ruby Gems" >> $GITHUB_STEP_SUMMARY
          gem_count=$(find artifacts/gem-* -name "*.gem" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $gem_count gems" >> $GITHUB_STEP_SUMMARY
          if [ "$gem_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/gem-* -name "*.gem" -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # CLI Binaries
          echo "### CLI Binaries" >> $GITHUB_STEP_SUMMARY
          cli_count=$(find artifacts/cli-* \( -name "*.tar.gz" -o -name "*.zip" \) 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $cli_count binaries" >> $GITHUB_STEP_SUMMARY
          if [ "$cli_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/cli-* \( -name "*.tar.gz" -o -name "*.zip" \) -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.build-wheels.result }}" = "success" ] && \
             [ "${{ needs.build-sdist.result }}" = "success" ] && \
             [ "${{ needs.build-napi-bindings.result }}" = "success" ] && \
             [ "${{ needs.build-ruby-gems.result }}" = "success" ] && \
             [ "${{ needs.build-cli-binaries.result }}" = "success" ]; then
            echo "## âœ… All builds succeeded!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All artifacts are ready for release." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Some builds failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the job details above for more information." >> $GITHUB_STEP_SUMMARY
          fi

          # Dry run notice
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "**Note**: This was a dry run. No artifacts were published." >> $GITHUB_STEP_SUMMARY
          fi
