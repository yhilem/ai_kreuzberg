name: Build Fastembed Test

on:
  push:
    branches:
      - test-fastembed-openssl
  pull_request:
    branches:
      - test-fastembed-openssl
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  PDFIUM_VERSION: "7529"
  RUST_BACKTRACE: short
  RUSTFLAGS: -D warnings
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0

jobs:
  build-fastembed:
    name: Build with official fastembed (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v6

      - name: Install system dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            build-essential

      - name: Install system dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install openssl pkg-config

      - name: Setup Rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Cache fastembed models
        uses: actions/cache@v4
        with:
          path: ~/.cache/fastembed
          key: fastembed-models-${{ runner.os }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            fastembed-models-${{ runner.os }}-

      - name: Pre-download fastembed models
        run: |
          # Create a simple Rust program to download the models
          mkdir -p /tmp/fastembed-test
          cd /tmp/fastembed-test
          cat > Cargo.toml <<'EOF'
          [package]
          name = "fastembed-test"
          version = "0.1.0"
          edition = "2021"

          [dependencies]
          fastembed = { version = "5.3", default-features = false, features = ["hf-hub-native-tls", "ort-download-binaries"] }
          EOF

          cat > src/main.rs <<'EOF'
          use fastembed::{EmbeddingModel, InitOptions, TextEmbedding};

          fn main() {
              println!("Downloading default model...");
              let _ = TextEmbedding::try_new(Default::default());

              println!("Downloading AllMiniLML6V2Q...");
              let _ = TextEmbedding::try_new(InitOptions::new(EmbeddingModel::AllMiniLML6V2Q));

              println!("Downloading BGEBaseENV15...");
              let _ = TextEmbedding::try_new(InitOptions::new(EmbeddingModel::BGEBaseENV15));

              println!("All models downloaded successfully!");
          }
          EOF

          mkdir -p src
          cargo run --release 2>&1 | grep -E "Downloading|downloaded|All models"
        continue-on-error: true
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          RUSTC_WRAPPER: ""

      - name: Install OpenSSL (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install openssl -y

      - name: Find OpenSSL installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          # Find OpenSSL installation directory
          $opensslDirs = @(
            "C:\Program Files\OpenSSL-Win64",
            "C:\Program Files\OpenSSL",
            "C:\ProgramData\chocolatey\lib\openssl\tools",
            "C:\Strawberry\c"
          )

          foreach ($dir in $opensslDirs) {
            if (Test-Path $dir) {
              Write-Host "Found OpenSSL at: $dir"
              if (Test-Path "$dir\lib") {
                Write-Host "Setting OPENSSL_DIR to $dir"
                echo "OPENSSL_DIR=$dir" >> $env:GITHUB_ENV
                echo "OPENSSL_LIB_DIR=$dir\lib" >> $env:GITHUB_ENV
                echo "OPENSSL_INCLUDE_DIR=$dir\include" >> $env:GITHUB_ENV
                Get-ChildItem -Path "$dir\lib" -Filter "*.lib" | Select-Object -First 5
                break
              }
            }
          }

          # Also try to use vcpkg as fallback
          if (-not (Test-Path env:OPENSSL_DIR)) {
            Write-Host "OpenSSL not found in standard locations, trying vcpkg..."
            vcpkg install openssl:x64-windows-static-md
            $vcpkgRoot = "C:\vcpkg\installed\x64-windows-static-md"
            if (Test-Path $vcpkgRoot) {
              echo "OPENSSL_DIR=$vcpkgRoot" >> $env:GITHUB_ENV
              echo "OPENSSL_LIB_DIR=$vcpkgRoot\lib" >> $env:GITHUB_ENV
              echo "OPENSSL_INCLUDE_DIR=$vcpkgRoot\include" >> $env:GITHUB_ENV
              echo "OPENSSL_STATIC=1" >> $env:GITHUB_ENV
            }
          }

      - name: Build kreuzberg with full features
        run: |
          cargo build --features full,embeddings --verbose
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          RUSTC_WRAPPER: ""

      - name: Run tests with full features
        run: |
          cargo test --features full,embeddings --verbose
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          RUSTC_WRAPPER: ""

      - name: Build Python bindings with embeddings
        if: runner.os != 'Windows'
        run: |
          pip install maturin
          cd crates/kreuzberg-py
          maturin build --features embeddings --release
        env:
          PKG_CONFIG_ALLOW_CROSS: 1
          RUSTC_WRAPPER: ""

      - name: Summary
        if: always()
        run: |
          echo "### Build Results for ${{ matrix.os }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Target: ${{ matrix.target }}" >> $GITHUB_STEP_SUMMARY
          echo "- OpenSSL: native-tls backend" >> $GITHUB_STEP_SUMMARY
          echo "- Fastembed: Official crates.io version 5.2" >> $GITHUB_STEP_SUMMARY
