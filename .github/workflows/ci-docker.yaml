name: CI Docker Build & Test

on:
  push:
    branches:
      - main
    paths:
      - 'docker/**'
      - '.dockerignore'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-cli/**'
      - 'crates/kreuzberg-tesseract/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'scripts/test_docker.sh'
      - '.github/workflows/ci-docker.yaml'
      - '.cargo/config.toml'
  pull_request:
    branches:
      - main
    paths:
      - 'docker/**'
      - '.dockerignore'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-cli/**'
      - 'crates/kreuzberg-tesseract/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'scripts/test_docker.sh'
      - '.github/workflows/ci-docker.yaml'
      - '.cargo/config.toml'
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip feature tests (build only)'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-docker:
    name: Build and Test Docker Image (${{ matrix.variant }})
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: read

    strategy:
      fail-fast: true
      matrix:
        variant:
          - core
          - full

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Free up disk space
        run: scripts/ci/docker/free-disk-space.sh

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: scripts/ci/docker/build-image.sh "${{ matrix.variant }}"

      - name: Test Docker image size
        run: scripts/ci/docker/check-image-size.sh "${{ matrix.variant }}"

      - name: Run comprehensive feature tests
        if: ${{ !inputs.skip_tests }}
        run: |
          echo "=== Running Docker feature tests (${{ matrix.variant }}) ==="
          ./scripts/test_docker.sh --skip-build --image kreuzberg:${{ matrix.variant }} --variant ${{ matrix.variant }} --verbose

      - name: Save Docker image as artifact
        if: success()
        run: scripts/ci/docker/save-image.sh "${{ matrix.variant }}" /tmp

      - name: Upload Docker image artifact
        if: success()
        uses: actions/upload-artifact@v5
        with:
          name: docker-image-${{ matrix.variant }}
          path: /tmp/kreuzberg-${{ matrix.variant }}.tar.gz
          retention-days: 7
          compression-level: 0

      - name: Upload test results
        if: always() && !inputs.skip_tests
        uses: actions/upload-artifact@v5
        with:
          name: docker-test-results-${{ matrix.variant }}
          path: /tmp/kreuzberg-docker-test-results.json
          retention-days: 7

      - name: Collect Docker logs on failure
        if: failure()
        run: scripts/ci/docker/collect-logs.sh /tmp/docker-logs

      - name: Upload Docker logs
        if: failure()
        uses: actions/upload-artifact@v5
        with:
          name: docker-logs-${{ matrix.variant }}
          path: /tmp/docker-logs/
          retention-days: 7

      - name: Clean up Docker resources
        if: always()
        run: scripts/ci/docker/cleanup.sh "${{ matrix.variant }}"

      - name: Summary
        if: success()
        run: scripts/ci/docker/summary.sh "${{ matrix.variant }}" /tmp/kreuzberg-docker-test-results.json
