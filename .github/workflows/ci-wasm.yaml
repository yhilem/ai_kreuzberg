name: CI WASM

on:
  push:
    branches-ignore:
      - 'benchmarking-*'
      - 'profiling-*'
      - 'feat/profiling-flamegraphs'
    paths:
      - '.github/actions/**'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-wasm/**'
      - 'packages/typescript/core/**'
      - 'packages/wasm/**'
      - 'e2e/wasm/**'
      - 'e2e/wasm-deno/**'
      - 'e2e/wasm-workers/**'
      - 'fixtures/**'
      - 'tools/e2e-generator/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'scripts/ci/wasm/**'
      - '.github/workflows/ci-wasm.yaml'
  pull_request:
    branches: [main]
    paths:
      - '.github/actions/**'
      - 'crates/kreuzberg/**'
      - 'crates/kreuzberg-wasm/**'
      - 'packages/typescript/core/**'
      - 'packages/wasm/**'
      - 'e2e/wasm/**'
      - 'e2e/wasm-deno/**'
      - 'e2e/wasm-workers/**'
      - 'fixtures/**'
      - 'tools/e2e-generator/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'pnpm-lock.yaml'
      - 'package.json'
      - 'scripts/ci/wasm/**'
      - '.github/workflows/ci-wasm.yaml'
  workflow_dispatch:

concurrency:
  group: ci-wasm-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short
  RUST_MIN_STACK: 16777216
  PDFIUM_VERSION: "7578"
  PDFIUM_STATIC_VERSION: "7442b"
  PDFIUM_WASM_VERSION: "7442b"
  MACOSX_DEPLOYMENT_TARGET: "14.0"
  WASM_RUSTFLAGS: "-C target-feature=+atomics,+bulk-memory -C link-arg=--shared-memory -C link-arg=--max-memory=2147483648 -C link-arg=--import-memory -C link-arg=--export=__wasm_init_tls -C link-arg=--export=__tls_size -C link-arg=--export=__tls_align -C link-arg=--export=__tls_base"

jobs:
  # ============================================================================
  # QUALITY & VALIDATION
  # ============================================================================

  lint-and-format:
    name: Lint & Format
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-lint
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Run cargo fmt check
        run: cargo fmt --all -- --check
        shell: bash

      - name: Run cargo clippy (excluding wasm target)
        run: cargo clippy --all-targets -- -D warnings
        working-directory: crates/kreuzberg-wasm
        shell: bash

      - name: Check WASM target compiles
        run: cargo build --target wasm32-unknown-unknown --lib
        working-directory: crates/kreuzberg-wasm
        shell: bash

      - name: Run biome check (TypeScript)
        run: scripts/ci/wasm/biome-check.sh
        shell: bash

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # UNIT & INTEGRATION TESTS (PLATFORM MATRIX)
  # ============================================================================

  unit-tests:
    name: Unit Tests (${{ matrix.os }})
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
          - os: macos-latest
          - os: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-test-${{ matrix.os }}
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        shell: bash
        run: scripts/ci/wasm/install-wasm-pack.sh

      - name: Run Rust unit tests
        run: wasm-pack test --node --release
        working-directory: crates/kreuzberg-wasm
        shell: bash
        env:
          RUST_BACKTRACE: 1

      - name: Run TypeScript tests
        run: scripts/ci/wasm/pnpm-test-wasm-crate.sh
        shell: bash

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # WASM BUILD TARGETS (PARALLEL ACROSS PLATFORMS)
  # ============================================================================

  build-wasm-targets:
    name: Build WASM (${{ matrix.os }})
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-latest
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-build-${{ matrix.target }}
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        shell: bash
        run: scripts/ci/wasm/install-wasm-pack.sh

      - name: Build WASM for Web
        run: scripts/ci/wasm/pnpm-build-wasm.sh web
        shell: bash
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Build WASM for Bundler
        run: scripts/ci/wasm/pnpm-build-wasm.sh bundler
        shell: bash
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Build WASM for Node.js
        run: scripts/ci/wasm/pnpm-build-wasm.sh nodejs
        shell: bash
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Build WASM for Deno
        run: scripts/ci/wasm/pnpm-build-wasm.sh deno
        shell: bash
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Download PDFium WASM
        shell: bash
        run: |
          curl -fL --retry 5 -o /tmp/pdfium-wasm.tgz \
            "https://github.com/bblanchon/pdfium-binaries/releases/download/chromium/${{ env.PDFIUM_VERSION }}/pdfium-wasm.tgz"
          mkdir -p wasm-libs
          tar -xzf /tmp/pdfium-wasm.tgz -C wasm-libs

      - name: Build WASM with PDFium (native target)
        run: scripts/ci/wasm/pnpm-build-wasm.sh nodejs
        shell: bash
        env:
          PDFIUM_WASM_LIB: ${{ github.workspace }}/wasm-libs
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Validate build artifacts (Web)
        shell: bash
        run: scripts/ci/wasm/validate-web-artifact.sh

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: wasm-${{ matrix.target }}
          path: crates/kreuzberg-wasm/pkg**/
          retention-days: 7

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # BUNDLE SIZE VALIDATION
  # ============================================================================

  bundle-size-check:
    name: Bundle Size Check
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-size
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        shell: bash
        run: scripts/ci/wasm/install-wasm-pack.sh

      - name: Build release WASM (Bundler target)
        run: scripts/ci/wasm/pnpm-build-wasm.sh bundler
        shell: bash
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Check WASM file sizes
        run: scripts/ci/wasm/check-wasm-file-sizes.sh
        shell: bash

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # TYPE DEFINITIONS VALIDATION
  # ============================================================================

  type-definitions:
    name: Type Definitions Check
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-types
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        shell: bash
        run: scripts/ci/wasm/install-wasm-pack.sh

      - name: Build WASM (required for type generation)
        run: scripts/ci/wasm/pnpm-build-wasm.sh bundler
        shell: bash
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Run TypeScript type check
        run: scripts/ci/wasm/typecheck-wasm-crate.sh
        shell: bash

      - name: Verify .d.ts files exist
        shell: bash
        run: scripts/ci/wasm/verify-dts-files.sh

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # NODE.JS INTEGRATION TESTS (MULTIPLE VERSIONS)
  # ============================================================================

  integration-tests-node:
    name: Integration Tests (Node ${{ matrix.node-version }})
    if: ${{ github.actor != 'dependabot[bot]' }}
    needs: [build-wasm-targets]
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        node-version: ["22", "25"]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace
        with:
          node-version: ${{ matrix.node-version }}

      - name: Download WASM artifacts
        uses: actions/download-artifact@v7
        with:
          name: wasm-x86_64-unknown-linux-gnu
          path: crates/kreuzberg-wasm/

      - name: Install dependencies
        run: scripts/ci/wasm/pnpm-install-wasm-crate.sh
        shell: bash

      - name: Build TypeScript wrapper
        run: scripts/ci/wasm/pnpm-build-ts-wasm-crate.sh
        shell: bash

      - name: Run integration tests
        run: scripts/ci/wasm/pnpm-test-wasm-crate.sh
        shell: bash

  # ============================================================================
  # DENO RUNTIME TESTS (MULTIPLE VERSIONS & PLATFORMS)
  # ============================================================================

  deno-tests:
    name: Deno Tests
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-deno-ubuntu
          target: wasm32-unknown-unknown

      - name: Setup Node (for wasm-pack and build tools)
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        shell: bash
        run: scripts/ci/wasm/install-wasm-pack.sh

      - name: Install Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: "2.x"

      - name: Build WASM package
        shell: bash
        run: scripts/ci/wasm/pnpm-build-wasm.sh deno
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Build TypeScript wrapper
        shell: bash
        run: scripts/ci/wasm/pnpm-build-ts-wasm-crate.sh

      - name: Generate Deno E2E tests
        shell: bash
        run: scripts/ci/wasm/generate-e2e-tests.sh wasm-deno

      - name: Link WASM package for testing
        shell: bash
        run: scripts/ci/wasm/pack-wasm-and-export-path.sh

      - name: Install WASM package in Deno tests
        shell: bash
        run: scripts/ci/wasm/deno-print-wasm-package-path.sh

      - name: Run Deno tests
        shell: bash
        run: scripts/ci/wasm/run-deno-tests.sh

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # CLOUDFLARE WORKERS TESTS
  # ============================================================================

  workers-tests:
    name: Cloudflare Workers Tests
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: wasm-workers
          target: wasm32-unknown-unknown

      - name: Setup Node
        uses: ./.github/actions/setup-node-workspace

      - name: Install wasm-pack
        run: scripts/ci/wasm/install-wasm-pack.sh

      - name: Build WASM package (size-optimized)
        run: scripts/ci/wasm/pnpm-build-wasm.sh bundler
        env:
          RUSTFLAGS: ${{ env.WASM_RUSTFLAGS }}

      - name: Build TypeScript wrapper
        run: scripts/ci/wasm/pnpm-build-ts-wasm-crate.sh

      - name: Verify WASM size for Workers
        run: scripts/ci/wasm/verify-workers-wasm-size.sh

      - name: Generate Workers E2E tests
        run: scripts/ci/wasm/generate-e2e-tests.sh wasm-workers

      - name: Install Workers test dependencies
        run: scripts/ci/wasm/pnpm-install-dir.sh e2e/wasm-workers

      - name: Run Miniflare tests
        run: scripts/ci/wasm/pnpm-test-dir.sh e2e/wasm-workers

      - name: Cleanup Rust cache
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

  # ============================================================================
  # FINAL STATUS GATE
  # ============================================================================

  all-checks-passed:
    name: All WASM Checks Passed
    if: ${{ github.actor != 'dependabot[bot]' }}
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs:
      - lint-and-format
      - unit-tests
      - build-wasm-targets
      - bundle-size-check
      - type-definitions
      - integration-tests-node
      - deno-tests
      - workers-tests
    steps:
      - name: Decide whether all checks passed
        env:
          LINT_AND_FORMAT: ${{ needs.lint-and-format.result }}
          UNIT_TESTS: ${{ needs.unit-tests.result }}
          BUILD_WASM_TARGETS: ${{ needs.build-wasm-targets.result }}
          BUNDLE_SIZE_CHECK: ${{ needs.bundle-size-check.result }}
          TYPE_DEFINITIONS: ${{ needs.type-definitions.result }}
          INTEGRATION_TESTS_NODE: ${{ needs.integration-tests-node.result }}
          DENO_TESTS: ${{ needs.deno-tests.result }}
          WORKERS_TESTS: ${{ needs.workers-tests.result }}
        run: scripts/ci/wasm/all-checks-passed.sh
