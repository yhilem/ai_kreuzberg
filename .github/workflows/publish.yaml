name: Publish Release

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to build (e.g., v4.0.0-rc.1)"
        required: true
        type: string
      dry_run:
        description: "Prepare artifacts without publishing"
        required: false
        type: boolean
        default: false
      ref:
        description: "Git ref (branch, tag, or commit) to build; defaults to the tag"
        required: false
        type: string
      targets:
        description: "Comma-separated list of release targets (all, python, node, ruby, cli, crates, docker, homebrew, java, csharp)"
        required: false
        type: string
  release:
    types: [published]
  repository_dispatch:
    types: [publish-release]

concurrency:
  group: ${{ github.workflow }}-${{ (github.event_name == 'workflow_dispatch' && (github.event.inputs.ref || github.event.inputs.tag)) || github.ref || github.run_id }}
  cancel-in-progress: false

env:
  CARGO_TERM_COLOR: always
  PDFIUM_VERSION: "7529"
  ORT_VERSION: "1.23.2"
  MACOSX_DEPLOYMENT_TARGET: "14.0"

permissions:
  contents: read

jobs:
  prepare:
    name: Prepare metadata
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.meta.outputs.version }}
      ref: ${{ steps.meta.outputs.ref }}
      dry_run: ${{ steps.meta.outputs.dry_run }}
      checkout_ref: ${{ steps.meta.outputs.checkout_ref }}
      target_sha: ${{ steps.meta.outputs.target_sha }}
      matrix_ref: ${{ steps.meta.outputs.matrix_ref }}
      is_tag: ${{ steps.meta.outputs.is_tag }}
      release_targets: ${{ steps.meta.outputs.release_targets }}
      release_any: ${{ steps.meta.outputs.release_any }}
      release_python: ${{ steps.meta.outputs.release_python }}
      release_node: ${{ steps.meta.outputs.release_node }}
      release_ruby: ${{ steps.meta.outputs.release_ruby }}
      release_cli: ${{ steps.meta.outputs.release_cli }}
      release_crates: ${{ steps.meta.outputs.release_crates }}
      release_rust: ${{ steps.meta.outputs.release_crates }}
      release_docker: ${{ steps.meta.outputs.release_docker }}
      release_homebrew: ${{ steps.meta.outputs.release_homebrew }}
      release_java: ${{ steps.meta.outputs.release_java }}
      release_csharp: ${{ steps.meta.outputs.release_csharp }}
      release_go: ${{ steps.meta.outputs.release_go }}
      release_wasm: ${{ steps.meta.outputs.release_wasm }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate tag and compute version
        id: meta
        env:
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          INPUT_TAG: ${{ inputs.tag }}
          INPUT_DRY_RUN: ${{ inputs.dry_run }}
          INPUT_REF: ${{ inputs.ref }}
          INPUT_TARGETS: ${{ inputs.targets }}
          EVENT_RELEASE_TAG: ${{ github.event.release.tag_name }}
          EVENT_DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          EVENT_DISPATCH_DRY_RUN: ${{ github.event.client_payload.dry_run }}
          EVENT_DISPATCH_REF: ${{ github.event.client_payload.ref }}
          EVENT_DISPATCH_TARGETS: ${{ github.event.client_payload.targets }}
        run: bash scripts/publish/prepare-release-metadata.sh

      - name: Upload release metadata
        uses: actions/upload-artifact@v5
        with:
          name: release-metadata
          path: release-metadata.json
          retention-days: 14

  validate-versions:
    name: Validate version consistency
    needs: [prepare]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}

      - name: Check version consistency
        run: |
          EXPECTED="${{ needs.prepare.outputs.version }}"
          ERRORS=0

          echo "Expected version: $EXPECTED"
          echo "----------------------------------------"

          # Rust workspace (Cargo.toml)
          CARGO_VERSION=$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)
          echo "Cargo.toml: $CARGO_VERSION"
          [ "$CARGO_VERSION" = "$EXPECTED" ] || { echo "❌ Cargo.toml mismatch"; ERRORS=$((ERRORS + 1)); }

          # Root package.json
          ROOT_VERSION=$(jq -r '.version' package.json)
          echo "package.json (root): $ROOT_VERSION"
          [ "$ROOT_VERSION" = "$EXPECTED" ] || { echo "❌ package.json (root) mismatch"; ERRORS=$((ERRORS + 1)); }

          # WASM package.json
          WASM_VERSION=$(jq -r '.version' crates/kreuzberg-wasm/package.json)
          echo "crates/kreuzberg-wasm/package.json: $WASM_VERSION"
          [ "$WASM_VERSION" = "$EXPECTED" ] || { echo "❌ WASM package.json mismatch"; ERRORS=$((ERRORS + 1)); }

          # Node package.json
          NODE_VERSION=$(jq -r '.version' crates/kreuzberg-node/package.json)
          echo "crates/kreuzberg-node/package.json: $NODE_VERSION"
          [ "$NODE_VERSION" = "$EXPECTED" ] || { echo "❌ Node package.json mismatch"; ERRORS=$((ERRORS + 1)); }

          # Python pyproject.toml
          PYTHON_VERSION=$(grep '^version' packages/python/pyproject.toml | head -1 | cut -d'"' -f2)
          echo "packages/python/pyproject.toml: $PYTHON_VERSION"
          [ "$PYTHON_VERSION" = "$EXPECTED" ] || { echo "❌ Python pyproject.toml mismatch"; ERRORS=$((ERRORS + 1)); }

          # Ruby version.rb
          RUBY_VERSION=$(grep "VERSION =" packages/ruby/lib/kreuzberg/version.rb | cut -d"'" -f2)
          echo "packages/ruby/lib/kreuzberg/version.rb: $RUBY_VERSION"
          [ "$RUBY_VERSION" = "$EXPECTED" ] || { echo "❌ Ruby version.rb mismatch"; ERRORS=$((ERRORS + 1)); }

          # Java pom.xml (first <version> tag is the project version)
          JAVA_VERSION=$(grep '<version>' packages/java/pom.xml | head -1 | sed 's/.*<version>\(.*\)<\/version>.*/\1/')
          echo "packages/java/pom.xml: $JAVA_VERSION"
          [ "$JAVA_VERSION" = "$EXPECTED" ] || { echo "❌ Java pom.xml mismatch"; ERRORS=$((ERRORS + 1)); }

          # C# Kreuzberg.csproj
          CSHARP_VERSION=$(grep '<Version>' packages/csharp/Kreuzberg/Kreuzberg.csproj | head -1 | sed 's/.*<Version>\(.*\)<\/Version>.*/\1/')
          echo "packages/csharp/Kreuzberg/Kreuzberg.csproj: $CSHARP_VERSION"
          [ "$CSHARP_VERSION" = "$EXPECTED" ] || { echo "❌ C# csproj mismatch"; ERRORS=$((ERRORS + 1)); }

          # Go doc.go version comment
          GO_VERSION=$(grep 'This binding targets Kreuzberg' packages/go/kreuzberg/doc.go | sed 's/.*Kreuzberg \([^ ]*\).*/\1/')
          echo "packages/go/kreuzberg/doc.go: $GO_VERSION"
          [ "$GO_VERSION" = "$EXPECTED" ] || { echo "❌ Go doc.go mismatch"; ERRORS=$((ERRORS + 1)); }

          echo "----------------------------------------"
          if [ $ERRORS -gt 0 ]; then
            echo "❌ $ERRORS version mismatches found"
            exit 1
          fi

          echo "✅ All 9 version sources consistent: $EXPECTED"


  check-pypi:
    name: Check if Python package exists on PyPI
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_python == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check PyPI for existing version
        id: check
        run: bash scripts/publish/check_pypi.sh "${{ needs.prepare.outputs.version }}" >> "$GITHUB_OUTPUT"

  check-npm:
    name: Check if Node package exists on npm
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_node == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check npm for existing version
        id: check
        run: bash scripts/publish/check_npm.sh "${{ needs.prepare.outputs.version }}" >> "$GITHUB_OUTPUT"

  check-rubygems:
    name: Check if Ruby gem exists on RubyGems
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_ruby == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check RubyGems for existing version
        id: check
        run: bash scripts/publish/check_rubygems.sh "${{ needs.prepare.outputs.version }}" >> "$GITHUB_OUTPUT"

  check-maven:
    name: Check if Java package exists on Maven Central
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_java == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Maven Central for existing version
        id: check
        run: bash scripts/publish/check_maven.sh "${{ needs.prepare.outputs.version }}" >> "$GITHUB_OUTPUT"

  check-nuget:
    name: Check if C# package exists on NuGet
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_csharp == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check NuGet for existing version
        id: check
        run: bash scripts/publish/check_nuget.sh "${{ needs.prepare.outputs.version }}" >> "$GITHUB_OUTPUT"

  check-cli:
    name: Check if CLI assets already published
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_cli == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Check release for existing CLI assets
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
          ASSET_PREFIX: kreuzberg-cli-
          SUMMARY_LABEL: CLI
        run: |
          bash scripts/publish/check-release-assets.sh

  check-go:
    name: Check if Go FFI assets already published
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_go == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      exists: ${{ steps.check.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Check release for existing Go artifacts
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.prepare.outputs.tag }}
          ASSET_PREFIX: go-ffi-
          SUMMARY_LABEL: Go FFI
        run: |
          bash scripts/publish/check-release-assets.sh

  check-docker:
    name: Check if Docker image tag exists
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' && needs.prepare.outputs.release_docker == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      core_exists: ${{ steps.core.outputs.exists }}
      full_exists: ${{ steps.full.outputs.exists }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Check core image tag
        id: core
        env:
          DOCKER_TAG: ${{ 'goldziher/kreuzberg' }}:${{ needs.prepare.outputs.version }}-core
          SUMMARY_LABEL: core
        run: bash scripts/publish/check-docker-tag.sh

      - name: Check full image tag
        id: full
        env:
          DOCKER_TAG: ${{ 'goldziher/kreuzberg' }}:${{ needs.prepare.outputs.version }}
          SUMMARY_LABEL: full
        run: bash scripts/publish/check-docker-tag.sh

  check-cratesio:
    name: Check if Rust crate exists on crates.io
    needs: prepare
    if: ${{ needs.prepare.outputs.is_tag == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      kreuzberg_exists: ${{ steps.check.outputs.kreuzberg_exists }}
      tesseract_exists: ${{ steps.check.outputs.tesseract_exists }}
      cli_exists: ${{ steps.check.outputs.cli_exists }}
      exists: ${{ steps.check.outputs.all_exist }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check crates.io for existing versions
        id: check
        run: bash scripts/publish/check_cratesio.sh "${{ needs.prepare.outputs.version }}" >> "$GITHUB_OUTPUT"

  python-wheels:
    name: Build Python wheels (${{ matrix.label }})
    needs: [prepare, check-pypi]
    if: ${{ needs.prepare.outputs.release_python == 'true' && needs.check-pypi.outputs.exists != 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 90
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-x86_64
            os: ubuntu-latest
            artifact: python-wheels-linux-x86_64
            rust_target: x86_64-unknown-linux-gnu
            manylinux: auto
            python: "3.10"
            needs_qemu: false
            extra_args: ""
          # TODO: Re-enable linux-aarch64 once build issues are resolved
          - label: macos-arm64
            os: macos-14
            artifact: python-wheels-macos
            needs_qemu: false
            python: "3.10"
            rust_target: aarch64-apple-darwin
            manylinux: ""
            extra_args: ""
          - label: windows-amd64
            os: windows-latest
            artifact: python-wheels-windows
            needs_qemu: false
            python: "3.10"
            rust_target: x86_64-pc-windows-msvc
            manylinux: ""
            extra_args: ""
    steps:
      - name: Maximize build disk space
        if: matrix.os == 'ubuntu-latest'
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 512
          swap-size-mb: 4096
          overprovision-lvm: 'true'
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup QEMU
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Cache Pdfium binaries
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Free up disk space for wheel build
        if: matrix.os == 'ubuntu-latest'
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Prepare wheel staging directory
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: mkdir -p target/wheels

      - name: Setup Tesseract cache
        id: tesseract-cache
        uses: ./.github/actions/setup-tesseract-cache
        with:
          label: ${{ matrix.label }}
          enable-cache: "true"
          rust-target: ${{ matrix.rust_target }}

      - name: Install macOS Rust targets
        if: matrix.label == 'macos-arm64'
        shell: bash
        run: rustup target add aarch64-apple-darwin

      - name: Clean previous wheel artifacts
        shell: bash
        run: rm -rf target/wheels target/maturin && rm -f packages/python/kreuzberg/_internal_bindings.*

      - name: Build Linux wheels
        if: matrix.os == 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          manylinux: ${{ matrix.manylinux }}
          working-directory: packages/python
          sccache: ${{ steps.tesseract-cache.outputs.cache-enabled }}
          docker-options: ${{ steps.tesseract-cache.outputs.docker-options }}
          before-script-linux: |
            set -euo pipefail
            # Ensure OpenSSL is available inside the manylinux container for openssl-sys
            if command -v yum >/dev/null 2>&1; then
              yum install -y openssl openssl-devel pkgconfig
              export OPENSSL_LIB_DIR=/usr/lib64
              export OPENSSL_INCLUDE_DIR=/usr/include
            elif command -v apt-get >/dev/null 2>&1; then
              apt-get update && apt-get install -y pkg-config libssl-dev
              export OPENSSL_LIB_DIR=/usr/lib/x86_64-linux-gnu
              export OPENSSL_INCLUDE_DIR=/usr/include
            fi

      - name: Build wheels (native)
        if: matrix.os != 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          working-directory: packages/python
          sccache: ${{ steps.tesseract-cache.outputs.cache-enabled }}

      - name: Setup Python (macOS)
        if: matrix.label == 'macos-arm64'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install wheel CLI (macOS)
        if: matrix.label == 'macos-arm64'
        run: python3 -m pip install wheel

      - name: Codesign macOS wheel binaries
        if: matrix.label == 'macos-arm64'
        shell: bash
        env:
          MACOS_CODESIGN_IDENTITY: ${{ secrets.MACOS_CODESIGN_IDENTITY }}
        run: python3 scripts/sign_macos_wheels.py --wheel-dir target/wheels

      - name: List built wheels
        shell: bash
        run: ls -lh target/wheels

      - name: Setup Python for smoke test
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Smoke test wheel
        shell: bash
        run: bash scripts/ci/python/smoke-test-wheel.sh

      - name: Clean up Docker resources (Ubuntu)
        if: matrix.os == 'ubuntu-latest' && always()
        run: bash scripts/publish/ubuntu/docker-prune.sh

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.artifact }}
          path: target/wheels/*.whl
          retention-days: 14

  python-sdist:
    name: Build Python sdist
    needs: [prepare, check-pypi]
    if: ${{ needs.prepare.outputs.release_python == 'true' && needs.check-pypi.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Show initial disk space
        run: echo "=== Initial disk space ===" && df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Free up disk space
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.13"
          cache-prefix: python-sdist

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-python-sdist

      - name: Build sdist
        run: bash scripts/build_python_sdist.sh dist

      - name: Upload sdist
        uses: actions/upload-artifact@v5
        with:
          name: python-sdist
          path: dist/*.tar.gz
          retention-days: 14

  node-bindings:
    name: Build Node bindings (${{ matrix.settings.target }})
    needs: [prepare, check-npm]
    if: ${{ needs.prepare.outputs.release_node == 'true' && needs.check-npm.outputs.exists != 'true' }}
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 90
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: macos-14
            target: aarch64-apple-darwin
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            rust_target: ""
            use_cross: false
            use_napi_cross: false
          # TODO: Re-enable additional Linux targets once cross-compilation pipeline matches test-build
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            rust_target: ""
            use_cross: false
            use_napi_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Show initial disk space (Linux)
        if: runner.os == 'Linux'
        run: echo "=== Initial disk space ===" && df -h /

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-node-${{ matrix.settings.target }}

      - name: Add Rust target
        if: ${{ matrix.settings.rust_target != '' }}
        run: rustup target add ${{ matrix.settings.rust_target }}

      - name: Install cross
        if: ${{ matrix.settings.use_cross }}
        run: cargo install cross --git https://github.com/cross-rs/cross --locked

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          check-latest: true

      - name: Enable corepack
        run: corepack enable

      - name: Prepare ONNX Runtime (macOS)
        if: startsWith(matrix.settings.target, 'aarch64-apple-darwin') || startsWith(matrix.settings.target, 'x86_64-apple-darwin')
        uses: ./.github/actions/setup-prebuilt-onnx
        with:
          target: ${{ matrix.settings.target }}

      - name: Install Node dependencies
        shell: bash
        run: bash scripts/publish/node/install-deps.sh

      - name: Clean npm directory
        if: runner.os != 'Windows'
        run: rm -rf crates/kreuzberg-node/npm

      - name: Clean npm directory (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: Remove-Item -Recurse -Force crates/kreuzberg-node\npm -ErrorAction SilentlyContinue

      - name: Create npm package structure
        run: pnpm --filter @kreuzberg/node exec napi create-npm-dirs

      - name: Build native module
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.settings.target }}
          USE_CROSS: ${{ matrix.settings.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.settings.use_napi_cross }}
        shell: bash
        run: bash scripts/publish/node/build-native-module.sh

      - name: Build native module (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.settings.target }}
          USE_CROSS: ${{ matrix.settings.use_cross }}
          USE_NAPI_CROSS: ${{ matrix.settings.use_napi_cross }}
        run: ./scripts/publish/node/build-native-module.ps1

      - name: Build TypeScript wrapper
        shell: bash
        run: pnpm -C crates/kreuzberg-node build:ts

      - name: Package artifacts
        if: runner.os != 'Windows'
        env:
          TARGET: ${{ matrix.settings.target }}
        shell: bash
        run: bash scripts/publish/node/package-artifacts.sh

      - name: Package artifacts (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          TARGET: ${{ matrix.settings.target }}
        run: ./scripts/publish/node/package-artifacts.ps1

      - name: Generate and upload TypeScript definitions
        if: matrix.settings.target == 'x86_64-unknown-linux-gnu'
        run: bash scripts/publish/node/generate-typescript-defs.sh

      - name: Upload TypeScript definitions
        if: matrix.settings.target == 'x86_64-unknown-linux-gnu'
        uses: actions/upload-artifact@v5
        with:
          name: node-typescript-defs
          path: typescript-defs
          retention-days: 14

      - name: Upload Node artifact
        uses: actions/upload-artifact@v5
        with:
          name: node-bindings-${{ matrix.settings.target }}
          path: node-bindings-${{ matrix.settings.target }}.tar.gz
          retention-days: 14

  cli-binaries:
    name: Build CLI binaries (${{ matrix.target }})
    needs: [prepare, check-cli]
    if: ${{ needs.prepare.outputs.release_cli == 'true' && (needs.check-cli.outputs.exists != 'true' || needs.prepare.outputs.dry_run == 'true') }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            use_cross: false
          # TODO: Re-enable x86_64-unknown-linux-musl once build issues are resolved
          # TODO: Add aarch64-unknown-linux-gnu once test-build parity is restored
          - os: macos-14
            target: aarch64-apple-darwin
            use_cross: false
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            use_cross: false
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Show initial disk space (Linux)
        if: runner.os == 'Linux'
        run: echo "=== Initial disk space ===" && df -h /

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          target: ${{ matrix.target }}
          cache-key-prefix: publish-cli-${{ matrix.target }}

      - name: Add compilation target
        run: rustup target add ${{ matrix.target }}

      - name: Install build dependencies
        if: runner.os == 'Linux'
        env:
          CLI_TARGET: ${{ matrix.target }}
        run: bash scripts/publish/cli/install-build-deps.sh

      - name: Configure cross linker
        if: ${{ matrix.target == 'aarch64-unknown-linux-gnu' }}
        run: bash scripts/publish/cli/configure-cross-linker.sh

      - name: Build CLI
        run: bash scripts/build_cli_binary.sh ${{ matrix.target }}

      - name: Package CLI artifact
        if: runner.os != 'Windows'
        run: bash scripts/package_cli_artifact.sh ${{ matrix.target }}

      - name: Package CLI artifact (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          CLI_TARGET: ${{ matrix.target }}
        run: ./scripts/publish/cli/package-cli-windows.ps1

      - name: Upload CLI artifact
        if: runner.os != 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: kreuzberg-cli-${{ matrix.target }}.tar.gz
          retention-days: 14

      - name: Upload CLI artifact (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: kreuzberg-cli-${{ matrix.target }}.zip
          retention-days: 14

  ruby-gem:
    name: Build Ruby gem (${{ matrix.label }})
    needs: [prepare, check-rubygems]
    if: ${{ needs.prepare.outputs.release_ruby == 'true' && needs.check-rubygems.outputs.exists != 'true' }}
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux
          - os: macos-14
            label: macos-arm64
          - os: windows-latest
            label: windows-x64
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    env:
      RB_SYS_CARGO_PROFILE: release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Show initial disk space (Linux)
        if: runner.os == 'Linux'
        run: echo "=== Initial disk space ===" && df -h /

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Install MSYS2 toolchain
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust (GNU on Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler: none
          bundler-cache: false

      - name: Install Bundler
        shell: bash
        run: (gem install bundler -v 4.0.0 --no-document || gem install bundler --no-document) && bundler --version

      - name: Configure short paths for Windows MAX_PATH mitigation
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/publish/ruby/windows-configure-short-paths.ps1

      - name: Configure bindgen compatibility headers (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/publish/ruby/windows-configure-bindgen-headers.ps1

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Stage Pdfium runtime artifacts
        uses: ./.github/actions/stage-pdfium-runtime
        with:
          destination: packages/ruby/ext/kreuzberg_rb/native
          additional-destinations: |
            packages/ruby
            packages/ruby/lib

      - name: Download ONNX Runtime (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/publish/ruby/windows-download-onnx-runtime.ps1

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        run: bash scripts/ci/ruby/install-ruby-deps.sh packages/ruby

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"; ridk exec bash -lc "cd $workspace && bash scripts/ci/ruby/install-ruby-deps.sh packages/ruby"

      - name: Vendor kreuzberg core crate
        shell: bash
        run: bash scripts/publish/ruby/vendor-kreuzberg-crate.sh

      - name: Build gem (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: packages/ruby
        run: bundle exec rake clean && bundle exec rake build

      - name: Build gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ./scripts/publish/ruby/build-gem-windows.ps1

      - name: Upload gem artifacts
        uses: actions/upload-artifact@v5
        with:
          name: rubygems-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 14

  go-ffi-libraries:
    name: Build Go FFI libraries (${{ matrix.settings.label }})
    needs: [prepare, check-go]
    if: ${{ needs.prepare.outputs.release_go == 'true' && (needs.check-go.outputs.exists != 'true' || needs.prepare.outputs.dry_run == 'true') }}
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            label: linux-x86_64
            target: x86_64-unknown-linux-gnu
            build_features: default
          - os: macos-14
            label: macos-arm64
            target: aarch64-apple-darwin
            build_features: default
          - os: windows-latest
            label: windows-x86_64
            target: x86_64-pc-windows-gnu
            build_features: core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Free up disk space (Linux)
        if: runner.os == 'Linux'
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Configure Windows GNU toolchain
        if: matrix.settings.os == 'windows-latest'
        shell: bash
        run: bash scripts/publish/go/configure-windows-gnu-toolchain.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: ${{ matrix.settings.os == 'windows-latest' && 'publish-go-windows-gnu' || format('publish-go-{0}', matrix.settings.os) }}
          use-sccache: ${{ matrix.settings.os != 'windows-latest' }}
          target: ${{ matrix.settings.target }}
          toolchain: ${{ matrix.settings.os == 'windows-latest' && 'stable-x86_64-pc-windows-gnu' || '' }}

      - name: Set GNU as default (Windows)
        if: matrix.settings.os == 'windows-latest'
        shell: pwsh
        run: rustup default stable-x86_64-pc-windows-gnu

      - name: Cache PDFium
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Setup ONNX Runtime (Unix only)
        if: matrix.settings.build_features == 'default'
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Setup MSYS2 (Windows)
        if: matrix.settings.os == 'windows-latest'
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-pkg-config
            mingw-w64-ucrt-x86_64-nasm
            mingw-w64-ucrt-x86_64-zstd
            mingw-w64-ucrt-x86_64-binutils

      - name: Verify MSYS2 toolchain and add to PATH (Windows)
        if: matrix.settings.os == 'windows-latest'
        shell: pwsh
        run: scripts/ci/go/setup-msys2-windows.ps1

      - name: Build FFI library (Windows)
        if: matrix.settings.os == 'windows-latest'
        shell: pwsh
        run: scripts/ci/go/build-ffi.ps1

      - name: Build FFI library (Unix)
        if: matrix.settings.os != 'windows-latest'
        shell: bash
        run: cargo build -p kreuzberg-ffi --release

      - name: Create artifact staging directory
        shell: bash
        run: |
          mkdir -p artifact-staging/kreuzberg-ffi/{lib,include,share/pkgconfig}

      - name: Stage FFI artifacts (Unix)
        if: matrix.settings.os != 'windows-latest'
        shell: bash
        run: scripts/ci/go/stage-ffi-artifacts.sh artifact-staging/kreuzberg-ffi "${{ matrix.settings.build_features }}"

      - name: Stage FFI artifacts (Windows)
        if: matrix.settings.os == 'windows-latest'
        shell: pwsh
        run: scripts/ci/go/stage-ffi-artifacts-windows.ps1 "artifact-staging\kreuzberg-ffi"

      - name: Generate installation README
        shell: bash
        run: scripts/ci/go/generate-install-readme.sh artifact-staging/kreuzberg-ffi/README.md

      - name: Package FFI library
        shell: bash
        run: tar -czf "go-ffi-${{ matrix.settings.label }}.tar.gz" -C artifact-staging kreuzberg-ffi/

      - name: Verify artifact completeness
        shell: bash
        run: scripts/ci/go/verify-ffi-artifact.sh "go-ffi-${{ matrix.settings.label }}.tar.gz"

      - name: Upload artifact
        uses: actions/upload-artifact@v5
        with:
          name: go-ffi-${{ matrix.settings.label }}
          path: go-ffi-${{ matrix.settings.label }}.tar.gz
          retention-days: 14

  java-natives:
    name: Build Java native libs (${{ matrix.settings.label }})
    needs: [prepare, check-maven]
    if: ${{ needs.prepare.outputs.release_java == 'true' && (needs.check-maven.outputs.exists != 'true' || needs.prepare.outputs.dry_run == 'true') }}
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            label: linux-x86_64
            rid: linux-x86_64
          - os: macos-15-intel
            label: macos-x86_64
            rid: macos-x86_64
          - os: macos-14
            label: macos-arm64
            rid: macos-arm64
          - os: windows-latest
            label: windows-x86_64
            rid: windows-x86_64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-java-natives-${{ matrix.settings.label }}
          use-sccache: ${{ runner.os != 'Windows' }}

      - name: Cache PDFium
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Stage PDFium into target/release
        uses: ./.github/actions/stage-pdfium-runtime
        with:
          destination: target/release

      - name: Setup ONNX Runtime (embeddings)
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}
          dest-dir: target/release

      - name: Build FFI library
        shell: bash
        run: cargo build -p kreuzberg-ffi --release

      - name: Fix macOS dylib references
        shell: bash
        run: bash scripts/ci/java/fix-macos-dylib-references.sh

      - name: Collect native artifacts
        shell: bash
        run: bash scripts/ci/java/collect-native-artifacts.sh "${{ matrix.settings.rid }}" "java-natives/${{ matrix.settings.rid }}"

      - name: Upload native artifact
        uses: actions/upload-artifact@v5
        with:
          name: java-natives-${{ matrix.settings.label }}
          path: java-natives/${{ matrix.settings.rid }}
          retention-days: 14

  java-package:
    name: Build Java package
    needs: [prepare, check-maven, java-natives]
    if: ${{ needs.prepare.outputs.release_java == 'true' && needs.check-maven.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      PDFIUM_VERSION: "7529"
    steps:
      - name: Show initial disk space
        run: echo "=== Initial disk space ===" && df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Free up disk space
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-java

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'
          cache: 'maven'

      - name: Cache PDFium
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Download Java native artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: java-natives-*
          path: artifacts/java-natives
          merge-multiple: false

      - name: Stage Java native resources
        shell: bash
        run: bash scripts/ci/java/stage-native-resources.sh "artifacts/java-natives" "packages/java/src/main/resources/natives"

      - name: Build and package
        working-directory: packages/java
        run: mvn clean package -DskipTests

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v5
        with:
          name: maven-packages
          path: packages/java/target/*.jar
          retention-days: 14

  java-smoke:
    name: Java Smoke Test (${{ matrix.os }})
    needs: [prepare, java-package]
    if: ${{ needs.prepare.outputs.release_java == 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}

      - name: Download JAR artifact
        uses: actions/download-artifact@v6
        with:
          name: maven-packages
          path: artifacts/java

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '25'

      - name: Smoke test (load natives from JAR)
        shell: bash
        run: bash scripts/ci/java/smoke.sh "artifacts/java"

  csharp-tests:
    name: Test C# bindings (${{ matrix.os }})
    needs: [prepare, check-nuget]
    if: ${{ needs.prepare.outputs.release_csharp == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-csharp-tests-${{ matrix.os }}

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.x"

      - name: Cache PDFium
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Stage PDFium runtime
        uses: ./.github/actions/stage-pdfium-runtime
        with:
          destination: target/release

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Setup Tesseract environment
        shell: bash
        run: source scripts/lib/tessdata.sh && setup_tessdata && echo "TESSDATA_PREFIX=${TESSDATA_PREFIX}" >> "$GITHUB_ENV"

      - name: Build FFI library
        run: cargo build -p kreuzberg-ffi --release

      - name: Run C# tests
        shell: bash
        env:
          KREUZBERG_FFI_DIR: ${{ github.workspace }}/target/release
        run: scripts/ci/csharp/run-tests.sh

      - name: Install Task
        uses: ./.github/actions/install-task

      - name: Run E2E tests
        shell: bash
        env:
          KREUZBERG_FFI_DIR: ${{ github.workspace }}/target/release
          LD_LIBRARY_PATH: ${{ github.workspace }}/target/release:${{ env.LD_LIBRARY_PATH }}
          DYLD_LIBRARY_PATH: ${{ github.workspace }}/target/release:${{ env.DYLD_LIBRARY_PATH }}
        run: |
          task e2e:csharp:test

  csharp-package:
    name: Build C# package
    needs: [prepare, check-nuget, csharp-tests, csharp-native-assets]
    if: ${{ needs.prepare.outputs.release_csharp == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Show initial disk space
        run: echo "=== Initial disk space ===" && df -h /

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Free up disk space
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-csharp

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.x"

      - name: Ensure dotnet is available
        run: bash scripts/publish/csharp/ensure-dotnet.sh

      - name: Download native assets
        uses: actions/download-artifact@v6
        with:
          pattern: csharp-native-assets-*
          path: packages/csharp/Kreuzberg
          merge-multiple: true

      - name: Restore C# dependencies
        run: dotnet restore packages/csharp/Kreuzberg/Kreuzberg.csproj

      - name: Build C# bindings
        run: dotnet build packages/csharp/Kreuzberg/Kreuzberg.csproj -c Release --no-restore

      - name: Pack NuGet package
        run: dotnet pack packages/csharp/Kreuzberg/Kreuzberg.csproj -c Release --no-build -p:PackageVersion=${{ needs.prepare.outputs.version }} -o artifacts/csharp

      - name: Verify package contains native assets
        shell: bash
        run: bash scripts/publish/csharp/verify-nuget-native-assets.sh

      - name: Upload NuGet artifact
        uses: actions/upload-artifact@v5
        with:
          name: csharp-nuget
          path: artifacts/csharp/*.nupkg
          retention-days: 14

  csharp-native-assets:
    name: Build C# native assets (${{ matrix.rid }})
    needs: [prepare, check-nuget]
    if: ${{ needs.prepare.outputs.release_csharp == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60
    permissions:
      contents: read
    strategy:
      fail-fast: true
      matrix:
        include:
          - rid: linux-x64
            os: ubuntu-latest
            rust_target: x86_64-unknown-linux-gnu
            ort_arch: x64
            pdfium_platform: linux
            pdfium_arch: x64
            ffi_name: libkreuzberg_ffi.so
          - rid: linux-arm64
            os: ubuntu-latest
            rust_target: aarch64-unknown-linux-gnu
            ort_arch: arm64
            pdfium_platform: linux
            pdfium_arch: arm64
            ffi_name: libkreuzberg_ffi.so
          - rid: osx-x64
            os: macos-latest
            rust_target: x86_64-apple-darwin
            ort_arch: x64
            pdfium_platform: mac
            pdfium_arch: x64
            ffi_name: libkreuzberg_ffi.dylib
          - rid: osx-arm64
            os: macos-latest
            rust_target: aarch64-apple-darwin
            ort_arch: arm64
            pdfium_platform: mac
            pdfium_arch: arm64
            ffi_name: libkreuzberg_ffi.dylib
          - rid: win-x64
            os: windows-latest
            rust_target: x86_64-pc-windows-msvc
            ort_arch: x64
            pdfium_platform: win
            pdfium_arch: x64
            ffi_name: kreuzberg_ffi.dll
          - rid: win-arm64
            os: windows-latest
            rust_target: aarch64-pc-windows-msvc
            ort_arch: arm64
            pdfium_platform: win
            pdfium_arch: arm64
            ffi_name: kreuzberg_ffi.dll
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Install system dependencies
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-csharp-native-${{ matrix.rid }}

      - name: Install Linux cross toolchain (arm64)
        if: ${{ runner.os == 'Linux' && matrix.rid == 'linux-arm64' }}
        shell: bash
        run: bash scripts/publish/csharp/install-linux-cross-toolchain-arm64.sh

      - name: Cache PDFium
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}
          platform-id: ${{ matrix.pdfium_platform }}
          arch-id: ${{ matrix.pdfium_arch }}

      - name: Setup ONNX Runtime
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}
          arch-id: ${{ matrix.ort_arch }}
          dest-dir: target/csharp-native/${{ matrix.rid }}

      - name: Stage PDFium runtime
        uses: ./.github/actions/stage-pdfium-runtime
        with:
          destination: target/csharp-native/${{ matrix.rid }}

      - name: Add Rust target
        shell: bash
        run: rustup target add "${{ matrix.rust_target }}"

      - name: Build FFI library
        shell: bash
        run: cargo build -p kreuzberg-ffi --release --target "${{ matrix.rust_target }}"

      - name: Assemble native assets for NuGet
        shell: bash
        env:
          RID: ${{ matrix.rid }}
          RUST_TARGET: ${{ matrix.rust_target }}
          FFI_NAME: ${{ matrix.ffi_name }}
        run: bash scripts/publish/csharp/assemble-native-assets.sh

      - name: Upload native assets artifact
        uses: actions/upload-artifact@v5
        with:
          name: csharp-native-assets-${{ matrix.rid }}
          path: runtimes/${{ matrix.rid }}/native/*
          retention-days: 14

  csharp-smoke:
    name: C# NuGet smoke (${{ matrix.os }})
    needs: [prepare, check-nuget, csharp-package]
    if: ${{ needs.prepare.outputs.release_csharp == 'true' && needs.check-nuget.outputs.exists != 'true' }}
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.x"

      - name: Download NuGet artifact
        uses: actions/download-artifact@v6
        with:
          name: csharp-nuget
          path: dist

      - name: Smoke test (load natives from NuGet)
        shell: bash
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: bash scripts/publish/csharp/smoke-test-nuget.sh

  cargo-packages:
    name: Package Rust crates
    needs: [prepare, check-cratesio]
    if: ${{ needs.prepare.outputs.release_rust == 'true' && needs.check-cratesio.outputs.exists != 'true' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-cargo-packages

      - name: Package crates
        env:
          RELEASE_VERSION: ${{ needs.prepare.outputs.version }}
        run: bash scripts/publish/cargo/package-crates.sh

      - name: Upload crate packages
        uses: actions/upload-artifact@v5
        with:
          name: cargo-crates
          path: crate-artifacts/*.crate
          retention-days: 14

  publish-docker:
    name: Publish Docker image (${{ matrix.variant }})
    needs:
      - prepare
      - validate-versions
      - check-docker
      - publish-crates
      - publish-pypi
    runs-on: ubuntu-latest
    timeout-minutes: 180
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - variant: core
            dockerfile: docker/Dockerfile.core
            image: goldziher/kreuzberg
            tag_suffix: "-core"
            extra_tag: "core"
          - variant: full
            dockerfile: docker/Dockerfile.full
            image: goldziher/kreuzberg
            tag_suffix: ""
            extra_tag: "latest"
    if: ${{ needs.prepare.outputs.release_docker == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.checkout_ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Free up disk space
        run: bash scripts/publish/ubuntu/free-disk-space.sh

      - name: Ensure target commit
        if: ${{ needs.prepare.outputs.target_sha != '' }}
        run: git checkout --progress --force ${{ needs.prepare.outputs.target_sha }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Skip because tag already exists
        if: ${{ (matrix.variant == 'core' && needs.check-docker.outputs.core_exists == 'true') || (matrix.variant == 'full' && needs.check-docker.outputs.full_exists == 'true') }}
        run: echo "Docker tag already exists for variant ${{ matrix.variant }}; skipping publish." >> "$GITHUB_STEP_SUMMARY"

      - name: Build AMD64 test image
        if: ${{ (matrix.variant == 'core' && needs.check-docker.outputs.core_exists != 'true' || matrix.variant == 'full' && needs.check-docker.outputs.full_exists != 'true') }}
        run: docker build -f ${{ matrix.dockerfile }} --build-arg PDFIUM_VERSION=${{ env.PDFIUM_VERSION }} -t kreuzberg-publish:${{ matrix.variant }}-test .

      - name: Run Docker feature tests
        if: ${{ (matrix.variant == 'core' && needs.check-docker.outputs.core_exists != 'true' || matrix.variant == 'full' && needs.check-docker.outputs.full_exists != 'true') }}
        run: ./scripts/test_docker.sh --skip-build --image kreuzberg-publish:${{ matrix.variant }}-test --variant ${{ matrix.variant }} --verbose

      - name: Log in to Docker Hub
        if: ${{ needs.prepare.outputs.dry_run != 'true' && (matrix.variant == 'core' && needs.check-docker.outputs.core_exists != 'true' || matrix.variant == 'full' && needs.check-docker.outputs.full_exists != 'true') }}
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        if: ${{ needs.prepare.outputs.dry_run != 'true' && (matrix.variant == 'core' && needs.check-docker.outputs.core_exists != 'true' || matrix.variant == 'full' && needs.check-docker.outputs.full_exists != 'true') }}
        id: docker_meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ matrix.image }}
          tags: |
            type=raw,value=${{ needs.prepare.outputs.version }}${{ matrix.tag_suffix }}
            type=raw,value=${{ matrix.extra_tag }}

      - name: Build and push multi-arch image
        if: ${{ needs.prepare.outputs.dry_run != 'true' && (matrix.variant == 'core' && needs.check-docker.outputs.core_exists != 'true' || matrix.variant == 'full' && needs.check-docker.outputs.full_exists != 'true') }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ${{ matrix.dockerfile }}
          push: true
          build-args: |
            PDFIUM_VERSION=${{ env.PDFIUM_VERSION }}
          tags: ${{ steps.docker_meta.outputs.tags }}
          labels: ${{ steps.docker_meta.outputs.labels }}
          platforms: linux/amd64,linux/arm64

      - name: Docker dry-run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: |
          echo "Dry run requested; Docker image ${{ matrix.image }}:${{ needs.prepare.outputs.version }}${{ matrix.tag_suffix }} tested but not pushed." >> "$GITHUB_STEP_SUMMARY"

      - name: Clean up local Docker images
        if: ${{ always() }}
        run: docker rmi kreuzberg-publish:${{ matrix.variant }}-test || true

  upload-cli-release:
    name: Upload CLI binaries to GitHub Release
    needs: [prepare, validate-versions, check-cli, cli-binaries]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_cli == 'true' &&
      needs.check-cli.outputs.exists != 'true' &&
      needs.cli-binaries.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Ensure GitHub release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/ensure-github-release-exists.sh "${{ needs.prepare.outputs.tag }}"

      - name: Download CLI artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: cli-*
          path: dist/cli
          merge-multiple: true

      - name: Upload CLI binaries (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/upload-cli-binaries.sh "${{ needs.prepare.outputs.tag }}" dist/cli

  upload-csharp-release:
    name: Upload C# NuGet to GitHub Release
    needs: [prepare, validate-versions, csharp-package]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_csharp == 'true' &&
      needs.csharp-package.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Ensure GitHub release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/ensure-github-release-exists.sh "${{ needs.prepare.outputs.tag }}"

      - name: Download C# artifacts
        uses: actions/download-artifact@v6
        with:
          name: csharp-nuget
          path: dist/csharp

      - name: Upload C# packages (idempotent)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/upload-csharp-packages.sh "${{ needs.prepare.outputs.tag }}" dist/csharp

  upload-go-release:
    name: Upload Go FFI libraries to GitHub Release
    needs: [prepare, validate-versions, check-go, go-ffi-libraries]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_go == 'true' &&
      needs.check-go.outputs.exists != 'true' &&
      needs.go-ffi-libraries.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Ensure GitHub release exists
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: bash scripts/publish/ensure-github-release-exists.sh "${{ needs.prepare.outputs.tag }}"

      - name: Download Go FFI artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: go-ffi-*
          path: dist/go
          merge-multiple: true

      - name: Upload Go FFI libraries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: for file in dist/go/go-ffi-*.tar.gz; do gh release upload "${{ needs.prepare.outputs.tag }}" "$file" --clobber; done

  publish-crates:
    name: Publish crates.io packages
    needs: [prepare, validate-versions, check-cratesio]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_rust == 'true' &&
      needs.check-cratesio.result == 'success' &&
      needs.check-cratesio.outputs.exists != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-crates

      - name: Request OIDC token for crates.io
        id: oidc
        uses: rust-lang/crates-io-auth-action@v1

      - name: Verify Cargo.toml version matches tag
        run: bash scripts/publish/verify-cargo-version.sh "${{ needs.prepare.outputs.version }}"

      - name: Check crates.io for existing release
        id: crate_check
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: bash scripts/publish/check_cratesio.sh "${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Publish kreuzberg-tesseract
        if: ${{ steps.crate_check.outputs.tesseract_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.oidc.outputs.token }}
        run: bash scripts/publish/publish-cargo-crate.sh kreuzberg-tesseract

      - name: Wait for tesseract indexing
        if: ${{ steps.crate_check.outputs.tesseract_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        run: bash scripts/publish/wait-for-package.sh cratesio "kreuzberg-tesseract" "${{ needs.prepare.outputs.version }}" 10

      - name: Publish kreuzberg
        if: ${{ steps.crate_check.outputs.core_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.oidc.outputs.token }}
        run: bash scripts/publish/publish-cargo-crate.sh kreuzberg

      - name: Wait for indexing
        if: ${{ steps.crate_check.outputs.core_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        run: bash scripts/publish/wait-for-package.sh cratesio "kreuzberg" "${{ needs.prepare.outputs.version }}" 10

      - name: Publish kreuzberg-cli
        if: ${{ steps.crate_check.outputs.cli_exists != 'true' && needs.prepare.outputs.dry_run != 'true' }}
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.oidc.outputs.token }}
        run: bash scripts/publish/publish-cargo-crate.sh kreuzberg-cli

      - name: Crates dry-run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: echo "Dry run requested; cargo publish skipped." >> "$GITHUB_STEP_SUMMARY"

  publish-pypi:
    name: Publish Python packages to PyPI
    needs: [prepare, validate-versions, check-pypi, python-wheels, python-sdist]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_python == 'true' &&
      needs.check-pypi.outputs.exists != 'true' &&
      needs.python-wheels.result == 'success' &&
      needs.python-sdist.result == 'success'
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download wheel artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: python-wheels-*
          path: dist
          merge-multiple: true

      - name: Download sdist artifact
        uses: actions/download-artifact@v6
        with:
          name: python-sdist
          path: dist

      - name: List artifacts
        run: ls -R dist

      - name: Publish to PyPI
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist
          skip-existing: true

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: (echo "Dry run requested; artifacts staged for PyPI:" && ls -1 dist) >> "$GITHUB_STEP_SUMMARY"

  publish-rubygems:
    name: Publish Ruby gems
    needs: [prepare, validate-versions, check-rubygems, ruby-gem]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_ruby == 'true' &&
      needs.check-rubygems.outputs.exists != 'true' &&
      needs.ruby-gem.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.tag }}

      - name: Download Ruby gem artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: rubygems-*
          path: dist
          merge-multiple: true

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'

      - name: Configure trusted publishing credentials
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: rubygems/configure-rubygems-credentials@v1.0.0

      - name: Publish gems to RubyGems
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          RUBYGEMS_VERSION: ${{ needs.prepare.outputs.version }}
        run: bash scripts/publish/push-gems-to-rubygems.sh dist

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        working-directory: dist
        run: (echo "Dry run requested; gem artifacts ready:" && ls -1 kreuzberg-*.gem) >> "$GITHUB_STEP_SUMMARY"

  publish-node:
    name: Publish Node packages
    needs: [prepare, validate-versions, check-npm, node-bindings]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_node == 'true' &&
      needs.check-npm.outputs.exists != 'true' &&
      needs.node-bindings.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Download Node artifacts
        uses: actions/download-artifact@v6
        with:
          pattern: node-bindings-*
          path: node-artifacts
          merge-multiple: true

      - name: Download TypeScript definitions
        uses: actions/download-artifact@v6
        with:
          name: node-typescript-defs
          path: typescript-defs

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org/

      - name: Update NPM
        run: npm install -g npm
        shell: bash

      - name: Enable corepack
        run: corepack enable

      - name: Prepare artifact directory
        run: bash scripts/publish/prepare-node-artifacts.sh node-artifacts typescript-defs crates/kreuzberg-node

      - name: Node artifacts summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: (echo "Dry run requested; Node binding tarballs staged:" && find node-artifacts -name '*.tar.gz' -print) >> "$GITHUB_STEP_SUMMARY"

      - name: Install workspace dependencies
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: pnpm install -C crates/kreuzberg-node

      - name: Build TypeScript bundle
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: pnpm -C crates/kreuzberg-node build:ts

      - name: Pack platform packages
        run: bash scripts/publish/pack-node-platform-packages.sh crates/kreuzberg-node/npm

      - name: Publish native binary packages
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: bash scripts/publish/publish-node-packages.sh crates/kreuzberg-node/npm

      - name: Wait for npm indexing
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: bash scripts/publish/wait-for-package.sh npm "@kreuzberg/node" "${{ needs.prepare.outputs.version }}" 10

      - name: Publish main Node package
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: bash scripts/publish/publish-main-node-package.sh crates/kreuzberg-node

  publish-wasm:
    name: Publish WASM package
    needs: [prepare, validate-versions, check-npm, publish-node]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_wasm == 'true' &&
      needs.check-npm.outputs.exists != 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}
          fetch-depth: 0
          submodules: recursive

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 22.6.0
          registry-url: https://registry.npmjs.org/

      - name: Enable corepack
        run: corepack enable

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-wasm

      - name: Add wasm32 target
        run: rustup target add wasm32-unknown-unknown

      - name: Install wasm-pack
        run: cargo install wasm-pack --locked

      - name: Install pnpm dependencies
        run: pnpm install --frozen-lockfile
        working-directory: crates/kreuzberg-wasm

      - name: Run cargo audit
        run: cargo audit --deny warnings
        working-directory: crates/kreuzberg-wasm

      - name: Build WASM for web target
        run: wasm-pack build --target web --out-dir pkg-web --release
        working-directory: crates/kreuzberg-wasm

      - name: Build WASM for bundler target
        run: wasm-pack build --target bundler --out-dir pkg-bundler --release
        working-directory: crates/kreuzberg-wasm

      - name: Build WASM for Node.js target
        run: wasm-pack build --target nodejs --out-dir pkg-nodejs --release
        working-directory: crates/kreuzberg-wasm

      - name: Build WASM for Deno target
        run: wasm-pack build --target deno --out-dir pkg-deno --release
        working-directory: crates/kreuzberg-wasm

      - name: Build TypeScript wrapper
        run: pnpm build
        working-directory: crates/kreuzberg-wasm

      - name: Run npm audit
        run: npm audit --audit-level=high
        working-directory: crates/kreuzberg-wasm

      - name: Extract version from package.json
        id: version
        run: echo "version=$(jq -r '.version' crates/kreuzberg-wasm/package.json)" >> "$GITHUB_OUTPUT"

      - name: Check if version already published to npm
        id: npm_check
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: bash scripts/publish/check-npm-version.sh "$VERSION" "@kreuzberg/wasm" >> "$GITHUB_OUTPUT"

      - name: Publish to npm
        if: ${{ steps.npm_check.outputs.exists != 'true' }}
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        working-directory: crates/kreuzberg-wasm
        run: npm publish --access public --provenance --ignore-scripts

      - name: Wait for npm indexing
        if: ${{ steps.npm_check.outputs.exists != 'true' }}
        run: bash scripts/publish/wait-for-package.sh npm "@kreuzberg/wasm" "${{ needs.prepare.outputs.version }}" 10

      - name: Package WASM artifacts
        if: ${{ steps.npm_check.outputs.exists != 'true' }}
        working-directory: crates/kreuzberg-wasm
        run: tar --exclude='node_modules' --exclude='target' --exclude='dist' --exclude='.git' -czf wasm-artifacts-${{ steps.version.outputs.version }}.tar.gz pkg-web pkg-bundler pkg-nodejs pkg-deno

      - name: Upload WASM artifacts to release
        if: ${{ steps.npm_check.outputs.exists != 'true' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload ${{ needs.prepare.outputs.tag }} crates/kreuzberg-wasm/wasm-artifacts-${{ steps.version.outputs.version }}.tar.gz --clobber

      - name: Publish summary
        env:
          WASM_ALREADY_PUBLISHED: ${{ steps.npm_check.outputs.exists }}
          WASM_VERSION: ${{ steps.version.outputs.version }}
        run: bash scripts/publish/wasm/write-summary.sh

  publish-maven:
    name: Publish Maven packages
    needs: [prepare, validate-versions, check-maven, java-package]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_java == 'true' &&
      needs.check-maven.outputs.exists != 'true' &&
      needs.java-package.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      PDFIUM_VERSION: "7529"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare.outputs.ref }}

      - name: Check Maven Central for existing release
        id: maven_check
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
        run: echo "exists=$(bash scripts/publish/check_maven.sh "${VERSION}" | cut -d= -f2)" >> "$GITHUB_OUTPUT"

      - name: Install system dependencies
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        uses: ./.github/actions/install-system-deps

      - name: Setup OpenSSL
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        uses: ./.github/actions/setup-openssl

      - name: Setup Rust
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: publish-maven

      - name: Patch legacy Maven GPG arguments
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        run: bash scripts/publish/patch-maven-gpg-args.sh packages/java/pom.xml

      - name: Setup Java
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        env:
          MAVEN_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPP_PASSPHRASE }}
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
          cache: maven
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Cache PDFium
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download PDFium
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Setup ONNX Runtime
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        uses: ./.github/actions/setup-onnx-runtime
        with:
          ort-version: ${{ env.ORT_VERSION }}

      - name: Prefer gpg2 binary
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        run: bash scripts/publish/prefer-gpg2-binary.sh

      - name: Release Maven package
        if: ${{ needs.prepare.outputs.dry_run != 'true' && steps.maven_check.outputs.exists != 'true' }}
        env:
          MAVEN_USERNAME: ${{ secrets.CENTRAL_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.CENTRAL_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPP_PASSPHRASE }}
        run: mvn -f packages/java/pom.xml --batch-mode --no-transfer-progress -Dgpg.passphrase="${MAVEN_GPG_PASSPHRASE}" -DskipTests clean deploy

      - name: Maven already published summary
        if: ${{ steps.maven_check.outputs.exists == 'true' }}
        run: echo "Maven package version ${{ needs.prepare.outputs.version }} already published; skipping." >> "$GITHUB_STEP_SUMMARY"

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: echo "Dry run requested; Maven publish skipped." >> "$GITHUB_STEP_SUMMARY"

  publish-nuget:
    name: Publish NuGet package
    needs: [prepare, validate-versions, check-nuget, csharp-tests, csharp-package, csharp-smoke]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_csharp == 'true' &&
      needs.check-nuget.outputs.exists != 'true' &&
      needs.csharp-package.result == 'success' &&
      needs.csharp-tests.result == 'success' &&
      needs.csharp-smoke.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download NuGet artifact
        uses: actions/download-artifact@v6
        with:
          name: csharp-nuget
          path: dist

      - name: Setup .NET
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: "10.x"

      - name: Ensure dotnet is available
        run: bash scripts/publish/csharp/ensure-dotnet.sh

      - name: NuGet login (OIDC → temp API key)
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        uses: NuGet/login@v1
        id: nuget_login
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Publish to NuGet
        if: ${{ needs.prepare.outputs.dry_run != 'true' }}
        run: dotnet nuget push "dist/*.nupkg" --source https://api.nuget.org/v3/index.json --api-key "${{ steps.nuget_login.outputs.NUGET_API_KEY }}" --skip-duplicate && echo "NuGet package published." >> "$GITHUB_STEP_SUMMARY"

      - name: Dry run summary
        if: ${{ needs.prepare.outputs.dry_run == 'true' }}
        run: (echo "Dry run requested; NuGet publish skipped." && ls -1 dist/*.nupkg) >> "$GITHUB_STEP_SUMMARY"

  publish-homebrew:
    name: Update Homebrew formula
    needs: [prepare, validate-versions, upload-cli-release]
    if: |
      always() &&
      needs.prepare.outputs.dry_run != 'true' &&
      needs.prepare.outputs.is_tag == 'true' &&
      needs.prepare.outputs.release_homebrew == 'true' &&
      needs.upload-cli-release.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Extract release info
        id: release
        env:
          TAG: ${{ needs.prepare.outputs.tag }}
          VERSION: ${{ needs.prepare.outputs.version }}
        run: bash scripts/publish/homebrew/extract-release-info.sh

      - name: Update Homebrew formula
        uses: mislav/bump-homebrew-formula-action@v3
        with:
          formula-name: kreuzberg
          formula-path: Formula/kreuzberg.rb
          homebrew-tap: kreuzberg-dev/homebrew-tap
          tag-name: ${{ needs.prepare.outputs.tag }}
          download-url: ${{ steps.release.outputs.url }}
          commit-message: |
            chore(homebrew): update kreuzberg to ${{ steps.release.outputs.version }}

            Auto-update from release ${{ steps.release.outputs.tag }}
        env:
          COMMITTER_TOKEN: ${{ secrets.HOMEBREW_TOKEN }}

  release-finalize:
    name: Finalize release and update notes
    needs:
      - prepare
      - check-pypi
      - check-npm
      - check-rubygems
      - check-maven
      - check-nuget
      - check-cratesio
      - publish-pypi
      - publish-node
      - publish-wasm
      - publish-rubygems
      - publish-maven
      - publish-nuget
      - publish-homebrew
      - publish-docker
      - upload-cli-release
      - upload-csharp-release
      - upload-go-release
    if: always() && needs.prepare.outputs.is_tag == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Aggregate release status
        id: status
        env:
          RELEASE_TAG: ${{ needs.prepare.outputs.tag }}
          CHECK_PYPI_EXISTS: ${{ needs.check-pypi.outputs.exists }}
          CHECK_NPM_EXISTS: ${{ needs.check-npm.outputs.exists }}
          CHECK_RUBYGEMS_EXISTS: ${{ needs.check-rubygems.outputs.exists }}
          CHECK_MAVEN_EXISTS: ${{ needs.check-maven.outputs.exists }}
          CHECK_NUGET_EXISTS: ${{ needs.check-nuget.outputs.exists }}
          RESULT_PUBLISH_PYPI: ${{ needs.publish-pypi.result }}
          RESULT_PUBLISH_NODE: ${{ needs.publish-node.result }}
          RESULT_PUBLISH_WASM: ${{ needs.publish-wasm.result }}
          RESULT_PUBLISH_RUBYGEMS: ${{ needs.publish-rubygems.result }}
          RESULT_PUBLISH_MAVEN: ${{ needs.publish-maven.result }}
          RESULT_PUBLISH_NUGET: ${{ needs.publish-nuget.result }}
          RESULT_PUBLISH_HOMEBREW: ${{ needs.publish-homebrew.result }}
          RESULT_PUBLISH_DOCKER: ${{ needs.publish-docker.result }}
          RESULT_UPLOAD_CLI_RELEASE: ${{ needs.upload-cli-release.result }}
          RESULT_UPLOAD_CSHARP_RELEASE: ${{ needs.upload-csharp-release.result }}
          RESULT_UPLOAD_GO_RELEASE: ${{ needs.upload-go-release.result }}
        run: python3 scripts/publish/aggregate-release-status.py
