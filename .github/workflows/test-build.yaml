name: Test Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    paths:
      - 'crates/**'
      - 'packages/**'
      - '.github/workflows/test-build.yaml'
      - '.github/actions/**'

concurrency:
  group: test-build-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_PROFILE_DEV_DEBUG: 0
  RUST_BACKTRACE: short
  PDFIUM_VERSION: "7529"
  ORT_VERSION: "1.23.2"
  MACOSX_DEPLOYMENT_TARGET: "14.0"

jobs:
  rust-smoke:
    name: Rust Smoke Test (Early)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: rust-smoke

      - name: Smoke test Rust crate
        uses: ./.github/actions/smoke-rust

  python-wheels:
    name: Build Python wheels (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - label: linux-x86_64
            os: ubuntu-latest
            artifact: wheels-linux-x86_64
            rust_target: x86_64-unknown-linux-gnu
            manylinux: auto
            python: "3.10"
            needs_qemu: false
            extra_args: ""
          # TODO: Re-enable linux-aarch64 once build issues are resolved
          # - label: linux-aarch64
          #   os: ubuntu-latest
          #   artifact: wheels-linux-aarch64
          #   rust_target: aarch64-unknown-linux-gnu
          #   manylinux: auto
          #   python: "3.10"
          #   needs_qemu: true
          #   extra_args: ""
          - label: macos-arm64
            os: macos-14
            artifact: wheels-macos
            python: "3.10"
            needs_qemu: false
            rust_target: aarch64-apple-darwin
            manylinux: ""
            extra_args: ""
          - label: windows-amd64
            os: windows-latest
            artifact: wheels-windows
            python: "3.10"
            rust_target: x86_64-pc-windows-msvc
            manylinux: ""
            needs_qemu: false
            extra_args: ""
    steps:
      - name: Maximize build disk space
        if: matrix.os == 'ubuntu-latest'
        uses: easimon/maximize-build-space@v10
        with:
          root-reserve-mb: 2048
          temp-reserve-mb: 512
          swap-size-mb: 4096
          overprovision-lvm: 'true'
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup QEMU
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Cache Pdfium binaries
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        if: matrix.os == 'ubuntu-latest' && matrix.needs_qemu
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Prepare wheel staging directory
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: mkdir -p target/wheels

      - name: Setup Tesseract cache
        id: tesseract-cache
        uses: ./.github/actions/setup-tesseract-cache
        with:
          label: ${{ matrix.label }}
          # enable-cache: ${{ matrix.label != 'linux-aarch64' }}
          rust-target: ${{ matrix.rust_target }}

      - name: Install macOS Rust targets
        if: matrix.label == 'macos-arm64'
        shell: bash
        run: rustup target add aarch64-apple-darwin

      - name: Build Linux wheels
        if: matrix.os == 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          manylinux: ${{ matrix.manylinux }}
          working-directory: packages/python
          sccache: ${{ steps.tesseract-cache.outputs.cache-enabled }}
          docker-options: ${{ steps.tesseract-cache.outputs.docker-options }}

      - name: Build wheels (native)
        if: matrix.os != 'ubuntu-latest'
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release -i python${{ matrix.python }} --out ../../target/wheels ${{ matrix.extra_args }}
          target: ${{ matrix.rust_target }}
          working-directory: packages/python
          sccache: ${{ steps.tesseract-cache.outputs.cache-enabled }}

      - name: List built wheels
        shell: bash
        run: ls -lh target/wheels

      - name: Smoke test Python wheel
        uses: ./.github/actions/smoke-python
        with:
          wheel-path: target/wheels
          python-version: ${{ matrix.python }}

      - name: Upload wheel artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ matrix.artifact }}
          path: target/wheels/*.whl

  java:
    name: Build Java bindings
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Java
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: "22"
          cache: 'maven'

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: java

      - name: Build Java binding
        run: mvn -f packages/java/pom.xml -DskipTests package

      - name: Smoke test Java bindings
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ§ª Running Java bindings smoke test"
          cd packages/java
          # Run basic smoke tests - verify the build worked and classes are loadable
          mvn test -Dtest="*SmokeTest" || mvn test -DfailIfNoTests=false
          echo "âœ“ Java bindings smoke test passed"

  go:
    name: Build Go bindings
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25"
          cache: true

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: go

      - name: Build FFI (release)
        run: cargo build -p kreuzberg-ffi --release

      - name: Go build (compile only)
        working-directory: packages/go/kreuzberg
        run: go build ./...

      - name: Smoke test Go bindings
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ§ª Running Go bindings smoke test"
          export LD_LIBRARY_PATH="${PWD}/target/release:${LD_LIBRARY_PATH:-}"
          cd packages/go
          go test -v ./...
          echo "âœ“ Go bindings smoke test passed"

  python-sdist:
    name: Build Python sdist
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: "3.13"
          cache-prefix: python-sdist

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: python-sdist

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Build sdist
        run: bash scripts/build_python_sdist.sh dist

      - name: Upload sdist artifact
        uses: actions/upload-artifact@v5
        with:
          name: python-sdist
          path: dist/*.tar.gz
          retention-days: 7

      - name: List built sdist
        run: bash scripts/list_artifacts.sh dist "*.tar.gz" "sdist"

  node-bindings:
    name: Build Node bindings (${{ matrix.settings.target }})
    runs-on: ${{ matrix.settings.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        settings:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: macos-14
            target: aarch64-apple-darwin
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: windows-latest
            target: aarch64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          package_json_file: package.json

      - name: Prepare ONNX Runtime (macOS)
        if: startsWith(matrix.settings.target, 'aarch64-apple-darwin') || startsWith(matrix.settings.target, 'x86_64-apple-darwin')
        uses: ./.github/actions/setup-prebuilt-onnx
        with:
          target: ${{ matrix.settings.target }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20
          cache: pnpm

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          target: ${{ matrix.settings.target }}
          cache-key-prefix: node-${{ matrix.settings.target }}

      - name: Install cross (Linux cross-compilation)
        if: matrix.settings.use_zigbuild
        run: cargo install cross --git https://github.com/cross-rs/cross --locked

      - name: Build NAPI-RS bindings (with cross)
        if: matrix.settings.use_zigbuild
        env:
          TARGET: ${{ matrix.settings.target }}
          USE_CROSS: ${{ matrix.settings.use_zigbuild }}
        run: bash scripts/build_napi_module.sh

      - name: Build NAPI-RS bindings (native)
        if: ${{ !matrix.settings.use_zigbuild }}
        env:
          TARGET: ${{ matrix.settings.target }}
        run: bash scripts/build_napi_module.sh

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload NAPI artifacts
        uses: actions/upload-artifact@v5
        with:
          name: napi-${{ matrix.settings.target }}
          path: |
            crates/kreuzberg-node/*.node
            crates/kreuzberg-node/*.tgz
          retention-days: 7

      - name: List built bindings
        run: |
          bash scripts/list_artifacts.sh crates/kreuzberg-node "*.node" "NAPI bindings"
          bash scripts/list_artifacts.sh crates/kreuzberg-node "*.tgz" "NAPI tarball"

      - name: Smoke test Node.js bindings
        uses: ./.github/actions/smoke-node
        with:
          package-tarball: crates/kreuzberg-node

  ruby-gem:
    name: Build Ruby gem (${{ matrix.label }})
    runs-on: ${{ matrix.os }}
    continue-on-error: ${{ matrix.label == 'windows-x64' }}
    timeout-minutes: 180
    env:
      RB_SYS_CARGO_PROFILE: release
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            label: linux-x86_64
            platform: x86_64-linux
            build_source_gem: true
          # TODO: Re-enable linux-aarch64 once build issues are resolved
          # - os: ubuntu-latest
          #   label: linux-aarch64
          #   platform: aarch64-linux
          #   build_source_gem: false
          - os: macos-14
            label: macos-arm64
            platform: arm64-darwin
            build_source_gem: false
          # TODO: Re-enable Windows once rb-sys fixes ssize_t type mismatch on Windows x64 with Ruby 3.3+
          # See: https://github.com/oxidize-rb/rb-sys tracking_allocator.rs issue
          # - os: windows-latest
          #   label: windows-x64
          #   platform: x64-mingw32
          #   build_source_gem: false
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          cache-key-prefix: ruby-${{ matrix.label }}

      - name: Install MSYS2 toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: ridk exec pacman -S --needed --noconfirm base-devel mingw-w64-ucrt-x86_64-toolchain

      - name: Install Rust GNU toolchain (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: rustup toolchain install stable-gnu --profile minimal --no-self-update

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
          bundler-cache: false

      - name: Configure bindgen sysroot (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          if (-not $env:RI_DEVKIT) {
            throw "RI_DEVKIT environment variable is not set"
          }
          $msysPrefix = ridk exec bash -lc 'printf %s "$MSYSTEM_PREFIX"'
          $msysPrefix = $msysPrefix.Trim()
          $riDevkit = $env:RI_DEVKIT -replace '\\','/'
          $sysroot = "$riDevkit$msysPrefix"
          Add-Content -Path $env:GITHUB_ENV -Value "BINDGEN_EXTRA_CLANG_ARGS=--target=x86_64-pc-windows-gnu --sysroot=$sysroot"

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Stage Pdfium runtime artifacts
        uses: ./.github/actions/stage-pdfium-runtime
        with:
          destination: packages/ruby/ext/kreuzberg_rb/native
          additional-destinations: packages/ruby

      - name: Setup ONNX Runtime (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ortVersion = "${{ env.ORT_VERSION }}"
          $ortDir = Join-Path $env:RUNNER_TEMP "onnxruntime\x86_64-pc-windows-gnu"
          if (-Not (Test-Path (Join-Path $ortDir "onnxruntime-win-x64-$ortVersion\lib\onnxruntime.dll"))) {
            New-Item -ItemType Directory -Force -Path $ortDir | Out-Null
            $zipPath = Join-Path $ortDir "onnxruntime.zip"
            $url = "https://github.com/microsoft/onnxruntime/releases/download/v$ortVersion/onnxruntime-win-x64-$ortVersion.zip"
            Invoke-WebRequest -Uri $url -OutFile $zipPath -UseBasicParsing
            Expand-Archive -Path $zipPath -DestinationPath $ortDir -Force
          }
          $onnxRoot = Get-ChildItem -Path $ortDir -Directory | Where-Object { $_.Name -like "onnxruntime-win-x64-*" } | Select-Object -First 1
          if (-not $onnxRoot) { throw "ONNX Runtime archive not found" }
          $destDir = Join-Path $env:GITHUB_WORKSPACE "packages\ruby\lib"
          New-Item -ItemType Directory -Force -Path $destDir | Out-Null
          Copy-Item -Path (Join-Path $onnxRoot.FullName "lib\*") -Destination $destDir -Force
          $envLines = @(
            "ORT_STRATEGY=system",
            "ORT_LIB_LOCATION=$($onnxRoot.FullName)\lib",
            "ORT_SKIP_DOWNLOAD=1",
            "ORT_PREFER_DYNAMIC_LINK=1",
            "ORT_DYLIB_PATH=$($onnxRoot.FullName)\lib"
          )
          $envLines | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
          $onnxRoot.FullName | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Install Ruby dependencies (Unix)
        if: runner.os != 'Windows'
        run: bash scripts/install_ruby_dependencies.sh packages/ruby

      - name: Install Ruby dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $rubydir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle config set --local path 'vendor/bundle' && bundle install --jobs 4 --retry 3"

      - name: Build native gem (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          RUBY_ARCH=$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['arch']")
          bundle exec rake native:kreuzberg:${RUBY_ARCH}

      - name: Package native gem (Unix)
        if: runner.os != 'Windows'
        working-directory: packages/ruby
        run: |
          set -euo pipefail
          RUBY_ARCH=$(ruby -e "require 'rbconfig'; print RbConfig::CONFIG['arch']")
          STAGE_DIR="tmp/${RUBY_ARCH}/stage"
          mkdir -p pkg
          if [ ! -f "${STAGE_DIR}/kreuzberg.gemspec" ]; then
            echo "Stage directory ${STAGE_DIR} missing" >&2
            exit 1
          fi
          (cd "${STAGE_DIR}" && gem build kreuzberg.gemspec)
          mv "${STAGE_DIR}"/kreuzberg-*.gem pkg/

      - name: Build native gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          # Get Ruby platform in PowerShell first to avoid bash escaping issues
          $rubyPlatform = ruby -e "puts Gem::Platform.local.to_s"
          ridk exec bash -lc "cd $rubydir && export RUSTUP_TOOLCHAIN=stable-gnu CC=x86_64-w64-mingw32-gcc CXX=x86_64-w64-mingw32-g++ && bundle exec rake native:kreuzberg:$rubyPlatform"

      - name: Package native gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          $rubyPlatform = ruby -e "puts Gem::Platform.local.to_s"
          ridk exec bash -lc "cd $rubydir && set -euo pipefail; mkdir -p pkg; stage_dir=\"tmp/$rubyPlatform/stage\"; if [ ! -f \"\$stage_dir/kreuzberg.gemspec\" ]; then echo \"Stage directory \$stage_dir missing\" >&2; exit 1; fi; (cd \"\$stage_dir\" && gem build kreuzberg.gemspec); mv \"\$stage_dir\"/kreuzberg-*.gem pkg/"

      - name: Build source gem (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $workspace = ridk exec bash -lc "cygpath -au '$env:GITHUB_WORKSPACE'"
          $rubydir = "$workspace/packages/ruby"
          ridk exec bash -lc "cd $rubydir && bundle exec rake build"

      - name: Build source gem
        if: matrix.build_source_gem
        working-directory: packages/ruby
        run: bundle exec rake build

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload native gem artifact
        uses: actions/upload-artifact@v5
        with:
          name: gem-${{ matrix.label }}
          path: packages/ruby/pkg/*.gem
          retention-days: 7

      - name: List built gems
        shell: bash
        run: |
          echo "ðŸ“¦ Built Ruby gem for ${{ matrix.label }}:"
          ls -lh packages/ruby/pkg/*.gem || echo "No gems found"

      - name: Smoke test Ruby gem
        uses: ./.github/actions/smoke-ruby
        with:
          gem-path: packages/ruby/pkg

  cli-binaries:
    name: Build CLI binaries (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 180
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact_name: kreuzberg
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact_name: kreuzberg.exe
          - os: macos-14
            target: aarch64-apple-darwin
            artifact_name: kreuzberg
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          submodules: recursive

      - name: Setup Rust toolchain
        uses: ./.github/actions/setup-rust
        with:
          target: ${{ matrix.target }}
          cache-key-prefix: cli-${{ matrix.target }}

      - name: Cache Pdfium binaries
        uses: ./.github/actions/cache-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Download Pdfium runtime
        uses: ./.github/actions/download-pdfium
        with:
          pdfium-version: ${{ env.PDFIUM_VERSION }}

      - name: Build CLI binary
        run: cargo build --release --target ${{ matrix.target }} --package kreuzberg-cli

      - name: Create tar.gz for Unix-like systems
        if: matrix.os != 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          tar czf kreuzberg-${{ matrix.target }}.tar.gz ${{ matrix.artifact_name }}
          mv kreuzberg-${{ matrix.target }}.tar.gz ../../../

      - name: Create zip for Windows
        if: matrix.os == 'windows-latest'
        run: |
          cd target/${{ matrix.target }}/release
          7z a -tzip kreuzberg-${{ matrix.target }}.zip ${{ matrix.artifact_name }}
          mv kreuzberg-${{ matrix.target }}.zip ../../../

      - name: Cleanup Rust cache before save
        if: always()
        uses: ./.github/actions/cleanup-rust-cache

      - name: Upload CLI binary artifacts
        uses: actions/upload-artifact@v5
        with:
          name: cli-${{ matrix.target }}
          path: |
            kreuzberg-${{ matrix.target }}.tar.gz
            kreuzberg-${{ matrix.target }}.zip
          retention-days: 7

      - name: List built binaries
        shell: bash
        run: |
          echo "ðŸ“¦ Built CLI binary for ${{ matrix.target }}:"
          ls -lh kreuzberg-${{ matrix.target }}.* || echo "No archives found"

      - name: Smoke test CLI binary
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ§ª Testing CLI binary for ${{ matrix.target }}"

          # Extract and test the binary we just built
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            cli_archive="kreuzberg-${{ matrix.target }}.zip"
            tmp=$(mktemp -d)
            unzip -q "$cli_archive" -d "$tmp"
            cli_bin="$tmp/kreuzberg.exe"
          else
            cli_archive="kreuzberg-${{ matrix.target }}.tar.gz"
            tmp=$(mktemp -d)
            tar -xzf "$cli_archive" -C "$tmp"
            cli_bin="$tmp/kreuzberg"
          fi

          if [ ! -f "$cli_bin" ]; then
            echo "ERROR: CLI binary extraction failed" >&2
            exit 1
          fi

          chmod +x "$cli_bin" || true

          # Set up Pdfium runtime library paths for Unix-like systems
          pdfium_runtime=""
          if [[ -n "${KREUZBERG_PDFIUM_PREBUILT:-}" ]]; then
            pdfium_runtime="$tmp/pdfium-runtime"
            mkdir -p "$pdfium_runtime"
            case "${RUNNER_OS:-Linux}" in
              Windows)
                src="$KREUZBERG_PDFIUM_PREBUILT/bin/pdfium.dll"
                filename="pdfium.dll"
                ;;
              macOS)
                src="$KREUZBERG_PDFIUM_PREBUILT/lib/libpdfium.dylib"
                filename="libpdfium.dylib"
                ;;
              Linux)
                src="$KREUZBERG_PDFIUM_PREBUILT/lib/libpdfium.so"
                filename="libpdfium.so"
                ;;
              *)
                echo "Unsupported RUNNER_OS '${RUNNER_OS:-}' for Pdfium staging" >&2
                exit 1
                ;;
            esac

            if [[ ! -f "$src" ]]; then
              echo "Pdfium runtime not found at $src" >&2
              exit 1
            fi

            dest="$pdfium_runtime/$filename"
            cp -f "$src" "$dest"

            case "${RUNNER_OS:-Linux}" in
              Windows)
                # Copy to the same directory as the binary on Windows
                cp -f "$dest" "$(dirname "$cli_bin")/$filename"
                ;;
              macOS)
                export DYLD_LIBRARY_PATH="$pdfium_runtime:${DYLD_LIBRARY_PATH:-}"
                ;;
              Linux)
                export LD_LIBRARY_PATH="$pdfium_runtime:${LD_LIBRARY_PATH:-}"
                ;;
            esac
          fi

          # Test CLI with version command
          output=$("$cli_bin" --version)
          if ! echo "$output" | grep -q "kreuzberg"; then
            echo "ERROR: CLI did not produce expected version output" >&2
            echo "Output: $output" >&2
            exit 1
          fi

          echo "âœ“ CLI binary smoke test passed for ${{ matrix.target }}"

  summarize:
    name: Build Summary
    needs:
      - rust-smoke
      - python-wheels
      - python-sdist
      - java
      - go
      - node-bindings
      - ruby-gem
      - cli-binaries
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v6
        with:
          path: artifacts/

      - name: Generate build summary
        run: |
          echo "# ðŸ—ï¸ Build Artifacts Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status (with integrated smoke tests)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status | Smoke Test Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|-------------------|" >> $GITHUB_STEP_SUMMARY
          echo "| Rust Smoke Test | ${{ needs.rust-smoke.result }} | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Wheels | ${{ needs.python-wheels.result }} | Integrated |" >> $GITHUB_STEP_SUMMARY
          echo "| Python Sdist | ${{ needs.python-sdist.result }} | N/A |" >> $GITHUB_STEP_SUMMARY
          echo "| Java Bindings | ${{ needs.java.result }} | Integrated |" >> $GITHUB_STEP_SUMMARY
          echo "| Go Bindings | ${{ needs.go.result }} | Integrated |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Bindings | ${{ needs.node-bindings.result }} | Integrated |" >> $GITHUB_STEP_SUMMARY
          echo "| Ruby Gem | ${{ needs.ruby-gem.result }} | Integrated |" >> $GITHUB_STEP_SUMMARY
          echo "| CLI Binaries | ${{ needs.cli-binaries.result }} | Integrated |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Built Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Wheels
          echo "### Python Wheels" >> $GITHUB_STEP_SUMMARY
          wheel_count=$(find artifacts/wheels-* -name "*.whl" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $wheel_count wheels" >> $GITHUB_STEP_SUMMARY
          if [ "$wheel_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/wheels-* -name "*.whl" -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python Sdist
          echo "### Python Sdist" >> $GITHUB_STEP_SUMMARY
          sdist_count=$(find artifacts/python-sdist -name "*.tar.gz" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $sdist_count sdist" >> $GITHUB_STEP_SUMMARY
          if [ "$sdist_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/python-sdist -name "*.tar.gz" -exec basename {} \; 2>/dev/null | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # NAPI Bindings
          echo "### NAPI Bindings" >> $GITHUB_STEP_SUMMARY
          napi_count=$(find artifacts/napi-* -name "*.node" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $napi_count bindings" >> $GITHUB_STEP_SUMMARY
          if [ "$napi_count" -gt 0 ]; then
            echo "- **Targets**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/napi-* -type d -name "napi-*" -exec basename {} \; 2>/dev/null | sed 's/napi-/  - /' | sort >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Ruby Gems
          echo "### Ruby Gems" >> $GITHUB_STEP_SUMMARY
          gem_count=$(find artifacts/gem-* -name "*.gem" 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $gem_count gems" >> $GITHUB_STEP_SUMMARY
          if [ "$gem_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/gem-* -name "*.gem" -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # CLI Binaries
          echo "### CLI Binaries" >> $GITHUB_STEP_SUMMARY
          cli_count=$(find artifacts/cli-* \( -name "*.tar.gz" -o -name "*.zip" \) 2>/dev/null | wc -l || echo "0")
          echo "- **Count**: $cli_count binaries" >> $GITHUB_STEP_SUMMARY
          if [ "$cli_count" -gt 0 ]; then
            echo "- **Files**:" >> $GITHUB_STEP_SUMMARY
            find artifacts/cli-* \( -name "*.tar.gz" -o -name "*.zip" \) -exec basename {} \; 2>/dev/null | sort | sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          # Overall status
          if [ "${{ needs.python-wheels.result }}" = "success" ] && \
             [ "${{ needs.python-sdist.result }}" = "success" ] && \
             [ "${{ needs.java.result }}" = "success" ] && \
             [ "${{ needs.go.result }}" = "success" ] && \
             [ "${{ needs.node-bindings.result }}" = "success" ] && \
             [ "${{ needs.ruby-gem.result }}" = "success" ] && \
             [ "${{ needs.cli-binaries.result }}" = "success" ]; then
            echo "## âœ… All builds and smoke tests succeeded!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All artifacts have been built and passed integration testing." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âš ï¸ Some builds or smoke tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the job details above for more information." >> $GITHUB_STEP_SUMMARY
          fi
