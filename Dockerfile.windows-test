# Docker image for testing Windows Go builds with MinGW cross-compilation
FROM ubuntu:24.04

# Avoid interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# Install MinGW-w64 toolchain and build dependencies
RUN apt-get update && apt-get install -y \
    curl \
    git \
    build-essential \
    mingw-w64 \
    pkg-config \
    cmake \
    nasm \
    wine64 \
    libzstd-dev \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
    --default-toolchain stable \
    --target x86_64-pc-windows-gnu
ENV PATH="/root/.cargo/bin:${PATH}"

# Add Windows GNU target
RUN rustup target add x86_64-pc-windows-gnu

# Install Go
ARG GO_VERSION=1.23.4
RUN curl -L "https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz" | tar -C /usr/local -xzf -
ENV PATH="/usr/local/go/bin:${PATH}"

# Configure MinGW toolchain for Rust
RUN mkdir -p /root/.cargo && \
    echo '[target.x86_64-pc-windows-gnu]\nlinker = "x86_64-w64-mingw32-gcc"\nar = "x86_64-w64-mingw32-ar"' > /root/.cargo/config.toml

# Set target-specific environment variables for cross-compilation
# Note: CC/CXX for host should not be set globally
ENV CARGO_TARGET_X86_64_PC_WINDOWS_GNU_LINKER=x86_64-w64-mingw32-gcc \
    CARGO_TARGET_X86_64_PC_WINDOWS_GNU_AR=x86_64-w64-mingw32-ar \
    CARGO_TARGET_X86_64_PC_WINDOWS_GNU_RUSTFLAGS="-C linker=x86_64-w64-mingw32-gcc" \
    ZSTD_DISABLE_LEGACY=1

# Verify installations
RUN rustc --version && \
    cargo --version && \
    go version && \
    x86_64-w64-mingw32-gcc --version && \
    nasm --version

WORKDIR /workspace

CMD ["/bin/bash"]
