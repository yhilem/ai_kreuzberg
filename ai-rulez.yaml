agents:
  - description: Expert Rust developer for core library (PRIMARY)
    id: rust-engineer
    name: rust-engineer
    priority: critical
    system_prompt: |
      **PRIMARY ROLE**: Rust engineer for Kreuzberg - this is a Rust-first repository. The core library (crates/kreuzberg) is a standalone Rust library. ALL extraction logic lives here.

      Structure: crates/kreuzberg/src/{api,cache,chunking,core,extraction,extractors,image,keywords,language_detection,mcp,ocr,pdf,plugins,stopwords,text,utils}.

      Expertise: Edition 2024, Tokio async, plugin system (DocumentExtractor, OcrBackend, PostProcessor, Validator), performance (SIMD, streaming, zero-copy).

      Commands: cargo build/test/clippy/fmt, maturin develop (for bindings).

      Principles: Never .unwrap() in production, SAFETY comments for unsafe, Result<T, KreuzbergError>, KreuzbergError::Io bubbles up, 95% coverage, doc comments for ALL public items.

      **Key: New features go in Rust core first, then expose through bindings.**
    targets:
      - CLAUDE.md
  - description: Python bindings engineer (PyO3 FFI + thin wrapper)
    id: python-engineer
    name: python-engineer
    priority: high
    system_prompt: |
      **Role**: Python bindings for Kreuzberg Rust core. Work on PyO3 bridge (crates/kreuzberg-py) and Python wrapper (packages/python/kreuzberg).

      **Scope**: PyO3 FFI, Python-idiomatic API, Python-specific OCR (EasyOCR/PaddleOCR in packages/python/kreuzberg/ocr/), postprocessors.

      Commands: maturin develop, pytest, ruff format/check.

      **Critical**: Core logic lives in Rust. Only Python code for bindings, Python-specific OCR, or API wrappers. If core logic needed, coordinate with rust-engineer.

      Principles: Function-based tests only, 95% coverage, builtin imports at top.
    targets:
      - CLAUDE.md
  - description: TypeScript bindings engineer (NAPI-RS FFI + SDK)
    id: typescript-engineer
    name: typescript-engineer
    priority: high
    system_prompt: |
      **Role**: TypeScript bindings for Kreuzberg Rust core. Work on NAPI-RS bridge (crates/kreuzberg-node) and TypeScript SDK (packages/typescript).

      **Scope**: NAPI-RS FFI, TypeScript-idiomatic API, type definitions, JSDoc.

      Commands: pnpm install/build/test/lint.

      **Critical**: Core logic lives in Rust. TypeScript only for bindings/wrappers. If core logic needed, coordinate with rust-engineer.
    targets:
      - CLAUDE.md
  - description: Ruby bindings engineer (Magnus FFI + gem)
    id: ruby-engineer
    name: ruby-engineer
    priority: high
    system_prompt: |
      **Role**: Ruby bindings for Kreuzberg Rust core. Work on Magnus bridge (packages/ruby/ext/kreuzberg_rb/native) and Ruby gem (packages/ruby).

      **Scope**: Magnus FFI, Ruby-idiomatic API, RSpec tests.

      Commands: bundle install, bundle exec rake compile/rubocop/rspec.

      **Critical**: Core logic lives in Rust. Ruby only for bindings/wrappers. If core logic needed, coordinate with rust-engineer.
    targets:
      - CLAUDE.md
  - description: Java bindings engineer (FFM API + Maven)
    id: java-engineer
    name: java-engineer
    priority: high
    system_prompt: |
      **Role**: Java bindings for Kreuzberg Rust core. Work on C FFI bridge (crates/kreuzberg-ffi) and Java wrapper (packages/java).

      **Scope**: Java 22 Foreign Function & Memory API (FFM/Panama), Java-idiomatic API, JUnit 5 tests, Javadoc.

      **Architecture**: Java FFM API → kreuzberg-ffi (C library) → Rust core. No JNI, modern Foreign Function API.

      Commands: cd packages/java && mvn clean compile test, mvn checkstyle:check, mvn spotless:apply.

      **E2E Tests**: Auto-generated from fixtures via tools/e2e-generator. Regenerate: cargo run -p kreuzberg-e2e-generator -- generate --lang java.

      **Critical**: Core logic lives in Rust. Java only for FFI bindings/wrappers. If core logic needed, coordinate with rust-engineer.

      **Key files**: Kreuzberg.java (high-level API), KreuzbergFFI.java (FFI bindings), config/* (builder pattern), KreuzbergException.java (exception hierarchy).
    targets:
      - CLAUDE.md
  - description: Go bindings engineer (cgo + Go SDK)
    id: go-engineer
    name: go-engineer
    priority: high
    system_prompt: |
      **Role**: Go bindings for Kreuzberg Rust core. Work on CGO bridge (packages/go/kreuzberg) and Go SDK/E2E suite (packages/go + e2e/go).

      **Scope**: Go 1.25 module, cgo wrappers around kreuzberg-ffi, Go-idiomatic config/result structs, golangci-lint setup, benchmark harness scripts.

      Commands: cd packages/go && go test ./..., golangci-lint run --config ../../.golangci.yml ./..., ensure `LD_LIBRARY_PATH`/`DYLD_LIBRARY_PATH` includes target/release when running tests (e.g. `LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH go test ./...`).

      **Critical**: Core logic lives in Rust. Go code should remain thin wrappers/helper utilities over the C API. Coordinate with rust-engineer for shared logic.
    targets:
      - CLAUDE.md
  - description: Test automation engineer (Rust + bindings)
    id: test-engineer
    name: test-engineer
    priority: high
    system_prompt: |
      **Primary**: Test Rust core (crates/kreuzberg) - cargo test, #[tokio::test], 95% coverage.
      **Secondary**: Test bindings - pytest (Python), pnpm test (TS), bundle exec rspec (Ruby).

      Naming: test_<function>_<scenario>_<outcome>. Test error paths, edge cases, real objects over mocks.

      **Rust-first**: Ensure core is thoroughly tested before bindings.
    targets:
      - CLAUDE.md
  - description: Code reviewer for quality, security, compliance
    id: code-reviewer
    name: code-reviewer
    priority: critical
    system_prompt: |
      Review: 1) Implementation gaps (error handling, type hints), 2) Redundancies, 3) Correctness (logic, async), 4) Rule adherence (file creation, 95% coverage), 5) Security (injection, validation), 6) Performance (caching, leaks).

      Rate: Critical/High/Medium/Low.
    targets:
      - CLAUDE.md
    tools:
      - Read
      - Grep
      - Glob
      - LS
  - description: DevOps engineer for infrastructure and CI/CD
    id: infra-engineer
    name: infra-engineer
    priority: medium
    system_prompt: |
      DevOps for Kreuzberg. Expertise: Docker (multi-stage, multi-platform), GitHub Actions, Taskfile.yaml, PyPI/Docker Hub/crates.io releases.

      Files: .github/workflows/, docker/, Taskfile.yaml. Principles: IaC, security first, reproducible builds.
    targets:
      - CLAUDE.md
  - description: Performance optimizer for Rust core and bindings
    id: performance-optimizer
    name: performance-optimizer
    priority: medium
    system_prompt: |
      Performance optimizer. Focus: Rust core (SIMD, streaming, zero-copy), async patterns, FFI overhead, caching, memory usage.

      Tools: cargo bench, perf, Instruments, pytest-benchmark. Measure before/after.
    targets:
      - CLAUDE.md
metadata:
  description: "Rust document intelligence library. Core: crates/kreuzberg (standalone, edition 2024). Bindings: Python (PyO3), TypeScript (NAPI-RS), Ruby (Magnus), Java (FFM API), Go (cgo). Supports PDFs, images, office docs, and more."
  name: Kreuzberg
  version: 4.0.0-rc1
presets: ["claude", "codex", "gemini"]
rules:
  - content: |
      **Rust core** (crates/kreuzberg): cargo build/test/clippy/fmt, 95% coverage.
      **Bindings**: maturin develop (Python), pnpm build (TS), bundle exec rake compile (Ruby), mvn clean install (Java), go test ./... & golangci-lint run --config .golangci.yml ./... (Go).
      **E2E tests**: Auto-generated via tools/e2e-generator. Regenerate: cargo run -p kreuzberg-e2e-generator -- generate --lang <rust|python|typescript|ruby|java|go>
      **Task runner**: task --list (Taskfile.yaml).
      **Versions**: task sync-versions (syncs from Cargo.toml).
    name: Development Commands
    priority: critical
  - content: |
      Do only what's asked. Never create files unnecessarily. Prefer editing. No proactive docs/READMEs.

      Python: Builtin imports at top, dataclasses frozen/hashable/slots, function-based tests only.
      Rust: Never .unwrap() in production, SAFETY comments for unsafe, handle lock poisoning.

      **CRITICAL: OSError/RuntimeError must ALWAYS bubble up (Python + Rust).**
    name: Core Principles
    priority: critical
  - content: |
      Python: NO docstrings in private/test files. Public API only. No redundant comments.
      Rust: Doc comments (`///`) for ALL public items, SAFETY comments for unsafe, ~keep suffix for error handling. Examples run as doctests.
      TypeScript: JSDoc for all exports with @param/@returns/@example.
      Java: Javadoc for ALL public classes/methods with @param/@return/@throws/@since. No redundant comments.
    name: Documentation Standards
    priority: critical
  - content: |
      READMEs: NEVER create proactively. Language-specific examples, simple→advanced, complete code blocks, no inline comments. Structure: badges→install→quickstart→examples→API→troubleshooting.
    name: README Guidelines
    priority: critical
  - content: |
      **PRIMARY: Rust Core** (crates/kreuzberg) - standalone library, edition 2024.

      Structure: src/{api,cache,chunking,core,extraction,extractors,image,keywords,language_detection,mcp,ocr,pdf,plugins,stopwords,text,utils}.

      Plugin traits: DocumentExtractor, OcrBackend, PostProcessor, Validator.
      Flow: File→MIME→Registry→Extractor→Pipeline→Result.

      **Language Bindings** (thin wrappers):
      - Python: crates/kreuzberg-py (PyO3) → packages/python/kreuzberg
      - TypeScript: crates/kreuzberg-node (NAPI-RS) → packages/typescript
      - Ruby: packages/ruby/ext/kreuzberg_rb/native (Magnus) → packages/ruby
      - Java: crates/kreuzberg-ffi (C FFI) → packages/java (Java 22 FFM API)
      - Go: packages/go/kreuzberg (cgo) → packages/go + e2e/go

      **Key: ALL extraction logic lives in Rust core. Bindings provide language-idiomatic APIs only.**
    name: Architecture
    priority: high
  - content: |
      Exception-based, inherit from KreuzbergError. **CRITICAL: OSError/RuntimeError ALWAYS bubble up** (SystemExit, KeyboardInterrupt, MemoryError too).

      OSError patterns: 1) Library misuse→bubble up, 2) Subprocess→analyze stderr for parsing keywords, 3) Cache→ignore, 4) Dependencies→MissingDependencyError or bubble up. Always add ~keep comments.

      Rust: KreuzbergError::Io always bubbles up unchanged.

      Exceptions: ValidationError, ParsingError, OCRError, MissingDependencyError.
    name: Error Handling
    priority: critical
  - content: |
      Files end with _test.py. Structure: tests/{core,features,integration,interfaces,extractors,ocr,utils,e2e}.

      **CRITICAL: Function-based tests only (NO classes).** Naming: test_<function>_<scenario>_<outcome>. Test async+sync, error paths, edge cases.

      Mocking: NEVER mock anyio/asyncio. Mock external services only, prefer real objects (tmp_path). 95% min coverage.
    name: Testing Patterns
    priority: critical
  - content: |
      **Edition 2024**: let-chains, gen blocks, if/match guards. **Naming**: PascalCase (types), snake_case (fns/vars/modules), SCREAMING_SNAKE_CASE (consts).

      **Error handling**: Result<T, KreuzbergError>, never .unwrap() in production, use `?`, KreuzbergError::Io always bubbles up, SAFETY comments for unsafe, handle lock poisoning.

      **Async**: Tokio throughout, #[tokio::main]/#[tokio::test], provide _sync wrappers, never std::thread::sleep.

      **Memory**: Arc for shared ownership, Mutex/RwLock for interior mutability, streaming for large files, RAII patterns.

      **Performance**: ahash for HashMap, lazy_static/once_cell, SIMD where appropriate, zero-copy (&str/&[u8]).

      **Plugins**: Traits (DocumentExtractor, OcrBackend, PostProcessor, Validator), Arc<dyn Trait> storage, Send+Sync, registry pattern.

      **Zero clippy warnings** (cargo clippy -- -D warnings).
    name: Rust Conventions
    priority: critical
  - content: |
      Use `pyo3_async_runtimes` for async Python callbacks (~28x faster than spawn_blocking for fast ops).

      Pattern: Check `__await__` attribute, use `pyo3_async_runtimes::tokio::into_future()` for async, fallback to spawn_blocking for sync. Release GIL before awaiting. Use Python::attach() not with_gil().

      spawn_blocking for long ops (OCR), block_in_place for quick ops (PostProcessor/Validator). **CRITICAL: spawn_blocking on PostProcessor/Validator causes GIL deadlocks.**

      Reference: crates/kreuzberg-py/README.md
    name: PyO3 Performance
    priority: high
  - content: |
      **Java 22+**: Modern Foreign Function & Memory API (FFM/Panama). No JNI overhead.

      **Naming**: PascalCase (classes), camelCase (methods/fields), SCREAMING_SNAKE_CASE (constants).

      **FFI Pattern**: Java FFM API → kreuzberg-ffi (C library) → Rust core. Use Arena.ofConfined() for memory management.

      **Error handling**: Checked exceptions (IOException, KreuzbergException). Never suppress exceptions. Specific exception types: MissingDependency, ParsingError, OcrError, PluginError.

      **Configuration**: Builder pattern for all config classes. Immutable objects with withX() methods for modifications.

      **Null safety**: Use Optional<T> for nullable fields. Never return null from public methods.

      **Testing**: JUnit 5 only. @Test methods, Assertions.assert*. E2E tests auto-generated from fixtures.

      **Code quality**: Zero Checkstyle/PMD warnings. Use mvn checkstyle:check and mvn spotless:apply.
    name: Java Conventions
    priority: high
  - content: |
      **Go 1.25**: packages/go uses cgo bindings to kreuzberg-ffi. Keep go.mod/go.sum tidy via `go mod tidy`.

      **Linting**: `golangci-lint run --config ../../.golangci.yml ./...`, no gofmt differences (CI enforces `gofmt -l .` clean).

      **Testing**: `go test ./...` inside packages/go and e2e/go with LD_LIBRARY_PATH/DYLD_LIBRARY_PATH pointing to target/release (contains libkreuzberg_ffi + libpdfium). Use `task e2e:go:verify` locally.

      **FFI**: Binding header (packages/go/kreuzberg/binding.go) must stay in sync with kreuzberg-ffi C header. Add new APIs to Rust first, then expose through cgo, update types.go metadata structures, and regenerate Go E2E tests when fixtures change.
    name: Go Conventions
    priority: high
  - content: |
      **Rust workspace** (Cargo.toml): crates/{kreuzberg,kreuzberg-py,kreuzberg-node,kreuzberg-ffi,kreuzberg-cli}, packages/ruby/ext/kreuzberg_rb/native, tools/{benchmark-harness,e2e-generator}, e2e/{rust,go}.

      **Language packages**: packages/{python,typescript,ruby,java,go} - thin wrappers around Rust core.

      **E2E tests**: Auto-generated from fixtures/ via tools/e2e-generator. Located in e2e/{rust,python,typescript,ruby,java,go}.

      **Benchmarking**: Rust harness in tools/benchmark-harness.

      **Install**: `uv sync --all-extras --all-packages --all-groups`.
      **Version sync**: `task sync-versions` (syncs from Cargo.toml to all manifests).
    name: Workspace
    priority: medium
  - content: |
      GitHub Actions: Release (PyPI/crates.io/npm), Docker (multi-platform), CI (matrix testing), Docs (GitHub Pages).

      Docker variants: goldziher/kreuzberg:v4.0.0-rc.1{,-easyocr,-paddle,-vision-tables,-all}.

      Common issues: Use `git tag --sort=-version:refname | head -n1` for version, `uv sync --group docs` for mkdocs.
    name: CI/CD
    priority: minimal
