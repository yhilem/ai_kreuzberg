# Cargo configuration for kreuzberg-wasm WASM target builds
# This file configures Rust compiler flags and build settings specific to
# WebAssembly (wasm32-unknown-unknown) compilation.

[build]
# Prevent wasm32 target rustflags from being applied to host builds
# (build scripts / proc-macros). Without this, host crates can fail to build
# because the wasm linker args are forwarded to the host linker (clang).
target-applies-to-host = false
#
# Context: We cross-compile from host architecture (x86_64/aarch64) to wasm32,
# so the [target.wasm32-unknown-unknown] settings below only apply to WASM builds.

[target.wasm32-unknown-unknown]
# rustflags = ["--cfg", "getrandom_backend=\"wasm_js\""]
#
# Rust compiler flags specific to the wasm32-unknown-unknown target.
# These flags configure how the Rust compiler builds code for WebAssembly.
#
# Flag Breakdown:
# ---------------
# --cfg getrandom_backend="wasm_js"
#
#   This conditional compilation flag tells the `getrandom` crate (used for
#   generating cryptographic random numbers) to use the "wasm_js" backend.
#
#   The getrandom crate needs a platform-specific random number source:
#   - On desktop: Uses /dev/urandom (Unix) or CryptoAPI (Windows)
#   - On WASM: Must use JavaScript's crypto.getRandomValues() API
#
#   Available getrandom backends for WASM:
#   - "wasm_js": Uses JavaScript's crypto.getRandomValues() - recommended
#   - "wasm_bindgen": Uses wasm-bindgen to call JS - alternative approach
#
#   "wasm_js" is preferred because it has minimal dependencies and direct
#   access to the Web Crypto API without wasm-bindgen overhead.
#
# Why this matters for Kreuzberg:
# --------------------------------
# Several dependencies (like UUIDs, session tokens, random sampling) need
# cryptographically secure random numbers. Without this flag, the WASM build
# would fail because the default backend is platform-specific and not available
# in WASM environments.
#
# Common errors if missing:
# - "getrandom backend is not supported on this platform"
# - Build fails during linking phase
# - Runtime errors about missing crypto support
#
# See Also:
# - https://docs.rs/getrandom/
# - https://docs.rs/getrandom/latest/getrandom/#wasm-support
# - https://developer.mozilla.org/en-US/docs/Web/API/Crypto/getRandomValues
rustflags = [
    "--cfg",
    "getrandom_backend=\"wasm_js\"",
    "-C",
    "target-feature=+atomics,+bulk-memory",
    "-C",
    "link-arg=--shared-memory",
    "-C",
    "link-arg=--max-memory=2147483648",
    "-C",
    "link-arg=--import-memory",
    "-C",
    "link-arg=--export=__wasm_init_tls",
    "-C",
    "link-arg=--export=__tls_size",
    "-C",
    "link-arg=--export=__tls_align",
    "-C",
    "link-arg=--export=__tls_base",
]
