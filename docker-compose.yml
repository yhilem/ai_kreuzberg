# Local build/test environment with Linux and Windows containers
services:
  linux:
    image: rust:1.85
    container_name: kreuzberg-linux-build
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/target
    environment:
      CARGO_TERM_COLOR: always
    tty: true
    restart: unless-stopped

  windows:
    image: dockurr/windows
    container_name: kreuzberg-windows
    environment:
      VERSION: "11"
    devices:
      - /dev/kvm
      - /dev/net/tun
    cap_add:
      - NET_ADMIN
    ports:
      - "8006:8006"
      - "3389:3389/tcp"
      - "3389:3389/udp"
    volumes:
      - ./windows:/storage
      - ./:/workspace
    restart: always
    stop_grace_period: 2m

  windows-build:
    build:
      context: .
      dockerfile: Dockerfile.windows-build
    container_name: kreuzberg-windows-build
    working_dir: /workspace
    volumes:
      - ./:/workspace
      - cargo-cache:/usr/local/cargo/registry
      - target-cache:/workspace/target
    environment:
      CARGO_TERM_COLOR: always
    command: >
      cross test --target x86_64-pc-windows-gnu
      --workspace
      --exclude kreuzberg-e2e-generator
      --all-features
    tty: true
    restart: "no"

volumes:
  cargo-cache:
  target-cache:
