<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <LangVersion>latest</LangVersion>

    <PackageId>Kreuzberg</PackageId>
    <Version>4.0.0-rc.15</Version>
    <Authors>kreuzberg.dev</Authors>
    <Company>kreuzberg.dev</Company>
    <Description>High-performance document intelligence library for .NET powered by Rust. Extract text, metadata, and structured content from 50+ file formats including PDF, Office documents, images, HTML, XML, and more. Features OCR support (Tesseract), metadata parsing, table extraction, and async/sync APIs. 10-50x faster than Python alternatives with 60-90% less memory usage.</Description>
    <PackageLicenseExpression>MIT</PackageLicenseExpression>
    <PackageProjectUrl>https://kreuzberg.dev</PackageProjectUrl>
    <RepositoryUrl>https://github.com/kreuzberg-dev/kreuzberg</RepositoryUrl>
    <RepositoryType>git</RepositoryType>
    <PackageTags>kreuzberg;document;extraction;rust;ffi;pdf;ocr;office;docx;excel;document-processing;document-intelligence;text-extraction;metadata;parsing;tesseract;dotnet;netcore</PackageTags>
    <PackageReadmeFile>README.md</PackageReadmeFile>
    <PackageReleaseNotes>Version 4.0.0 Release Candidate 2: C# bindings with .NET 9+ FFM API support, documentation improvements with MkDocs, CI/CD infrastructure fixes, benchmark harness improvements, and comprehensive test suite passing (268+ tests).</PackageReleaseNotes>
  </PropertyGroup>

  <ItemGroup>
    <None Include="../README.md" Pack="true" PackagePath="/" />
    <None Include="runtimes/**" Pack="true" PackagePath="runtimes/" />
  </ItemGroup>

  <!-- Copy native libraries from kreuzberg-ffi build output to runtimes directory.
       IMPORTANT: This target only copies libraries from local build output when developing.
       In CI workflows, native assets are pre-downloaded as artifacts BEFORE this target runs.
       To avoid overwriting CI artifacts, we skip this target if runtimes directory already has cross-platform files.
       In CI: artifacts are downloaded to packages/csharp/Kreuzberg/runtimes before build (line 1483 in publish.yaml)
       Locally: this target copies from target/release/build for single-platform development builds. -->
  <Target Name="CopyNativeLibraries" BeforeTargets="Build">
    <PropertyGroup>
      <RuntimesDir>$(MSBuildThisFileDirectory)runtimes</RuntimesDir>
      <KreuzbergReleaseDir>$(MSBuildThisFileDirectory)../../../target/release</KreuzbergReleaseDir>
      <!-- Skip copy if runtimes directory already has cross-platform files (populated by CI artifacts) -->
      <RuntimesAlreadyPopulated Condition="Exists('$(RuntimesDir)/linux-x64/native') OR Exists('$(RuntimesDir)/win-x64/native')">true</RuntimesAlreadyPopulated>
    </PropertyGroup>

    <!-- Skip this entire target if runtimes were pre-populated by CI artifacts -->
    <Message Text="Native libraries already exist in runtimes/ directory (CI artifacts). Skipping copy." Condition="'$(RuntimesAlreadyPopulated)' == 'true'" Importance="high" />
  </Target>

  <!-- Only run the actual copy if not already populated -->
  <Target Name="PerformNativeLibraryCopy" BeforeTargets="Build" Condition="'$(RuntimesAlreadyPopulated)' != 'true'">
    <PropertyGroup>
      <RuntimesDir>$(MSBuildThisFileDirectory)runtimes</RuntimesDir>
      <KreuzbergReleaseDir>$(MSBuildThisFileDirectory)../../../target/release</KreuzbergReleaseDir>
    </PropertyGroup>

    <!-- macOS arm64 (M1/M2/M3) -->
    <MakeDir Directories="$(RuntimesDir)/osx-arm64/native" />
    <Copy SourceFiles="$(KreuzbergReleaseDir)/libkreuzberg_ffi.dylib" DestinationFolder="$(RuntimesDir)/osx-arm64/native" Condition="Exists('$(KreuzbergReleaseDir)/libkreuzberg_ffi.dylib')" />
    <ItemGroup>
      <NativePdfiumLib Include="$(KreuzbergReleaseDir)/build/kreuzberg-*/out/libpdfium.dylib" />
    </ItemGroup>
    <Copy SourceFiles="@(NativePdfiumLib)" DestinationFolder="$(RuntimesDir)/osx-arm64/native" Condition="'@(NativePdfiumLib)' != ''" />

    <!-- macOS x64 (Intel) -->
    <MakeDir Directories="$(RuntimesDir)/osx-x64/native" />
    <Copy SourceFiles="$(KreuzbergReleaseDir)/libkreuzberg_ffi.dylib" DestinationFolder="$(RuntimesDir)/osx-x64/native" Condition="Exists('$(KreuzbergReleaseDir)/libkreuzberg_ffi.dylib')" />
    <Copy SourceFiles="@(NativePdfiumLib)" DestinationFolder="$(RuntimesDir)/osx-x64/native" Condition="'@(NativePdfiumLib)' != ''" />

    <!-- Linux x64 -->
    <MakeDir Directories="$(RuntimesDir)/linux-x64/native" />
    <Copy SourceFiles="$(KreuzbergReleaseDir)/libkreuzberg_ffi.so" DestinationFolder="$(RuntimesDir)/linux-x64/native" Condition="Exists('$(KreuzbergReleaseDir)/libkreuzberg_ffi.so')" />
    <ItemGroup>
      <NativePdfiumLinux Include="$(KreuzbergReleaseDir)/build/kreuzberg-*/out/libpdfium.so*" />
    </ItemGroup>
    <Copy SourceFiles="@(NativePdfiumLinux)" DestinationFolder="$(RuntimesDir)/linux-x64/native" Condition="'@(NativePdfiumLinux)' != ''" />

    <!-- Linux arm64 -->
    <MakeDir Directories="$(RuntimesDir)/linux-arm64/native" />
    <Copy SourceFiles="$(KreuzbergReleaseDir)/libkreuzberg_ffi.so" DestinationFolder="$(RuntimesDir)/linux-arm64/native" Condition="Exists('$(KreuzbergReleaseDir)/libkreuzberg_ffi.so')" />
    <Copy SourceFiles="@(NativePdfiumLinux)" DestinationFolder="$(RuntimesDir)/linux-arm64/native" Condition="'@(NativePdfiumLinux)' != ''" />

    <!-- Windows x64 -->
    <MakeDir Directories="$(RuntimesDir)/win-x64/native" />
    <Copy SourceFiles="$(KreuzbergReleaseDir)/kreuzberg_ffi.dll" DestinationFolder="$(RuntimesDir)/win-x64/native" Condition="Exists('$(KreuzbergReleaseDir)/kreuzberg_ffi.dll')" />
    <ItemGroup>
      <NativePdfiumDll Include="$(KreuzbergReleaseDir)/build/kreuzberg-*/out/pdfium.dll" />
    </ItemGroup>
    <Copy SourceFiles="@(NativePdfiumDll)" DestinationFolder="$(RuntimesDir)/win-x64/native" Condition="'@(NativePdfiumDll)' != ''" />

    <!-- Windows arm64 -->
    <MakeDir Directories="$(RuntimesDir)/win-arm64/native" />
    <Copy SourceFiles="$(KreuzbergReleaseDir)/kreuzberg_ffi.dll" DestinationFolder="$(RuntimesDir)/win-arm64/native" Condition="Exists('$(KreuzbergReleaseDir)/kreuzberg_ffi.dll')" />
    <Copy SourceFiles="@(NativePdfiumDll)" DestinationFolder="$(RuntimesDir)/win-arm64/native" Condition="'@(NativePdfiumDll)' != ''" />

    <Message Text="Native libraries copied to $(RuntimesDir)" Importance="high" />
  </Target>
</Project>
